<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToolCrib Requisiciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' } },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-in': 'slideIn 0.3s ease-out forwards', 'slide-out': 'slideOut 0.3s ease-in forwards' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideIn: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        slideOut: { '0%': { transform: 'translateX(0)', opacity: '1' }, '100%': { transform: 'translateX(100%)', opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        #toast-container { position: fixed !important; bottom: 1.5rem !important; right: 1.5rem !important; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { @apply flex items-center p-4 w-80 bg-white rounded-lg shadow-xl border-l-4 animate-slide-in; }
        .toast-success { @apply border-green-500; } .toast-error { @apply border-red-500; } .toast-info { @apply border-blue-500; } .toast.hiding { @apply animate-slide-out; }
        
        input:read-only { @apply bg-gray-100 text-gray-500 cursor-not-allowed; }
        .aspect-w-1 { position: relative; padding-bottom: 100%; } 
        .aspect-w-1 > * { position: absolute; height: 100%; width: 100%; top: 0; right: 0; bottom: 0; left: 0; }
        
        .btn { @apply px-4 py-2 rounded-lg font-medium shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .btn-primary { @apply bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500; }
        .btn-secondary { @apply bg-gray-100 text-gray-700 hover:bg-gray-200 focus:ring-gray-300; }
        .btn-danger { @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500; }
        .btn.p-2\.5 { @apply p-2.5 leading-none; }

        /* Estilos Nuevos para Variantes */
        .variant-row { @apply flex gap-2 mb-2 items-center animate-fade-in; }
        .variant-input { @apply w-1/2 rounded-lg border-gray-300 text-xs focus:ring-primary-500 focus:border-primary-500; }
        .variant-btn-del { @apply text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition flex-shrink-0; }

        @media (max-width: 640px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody tr { @apply flex flex-col mb-4 bg-white rounded-xl shadow-sm border border-gray-200 p-5 mx-4; }
            .responsive-table td { @apply flex justify-between items-start py-3 px-0 border-b border-gray-100 last:border-0; }
            .responsive-table td::before { content: attr(data-label); @apply font-medium text-gray-500 text-sm mr-4 flex-shrink-0 w-1/3; }
            .responsive-table td > * { @apply text-right w-full; }
            .responsive-table td { text-align: right; }
            .responsive-table td.col-acciones { @apply justify-end mt-3 pt-3 border-t border-gray-100; }
            .responsive-table td.col-acciones::before { display: none; }
        }
        @media (max-width: 1024px) and (min-width: 640px) { #admin-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { #admin-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .btn-view.active { @apply bg-primary-100 text-primary-600; }
        .btn-view:not(.active) { @apply bg-white text-gray-400 hover:text-gray-600; }
        #admin-variants-container { display: none; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
    <div id="toast-container"></div>
    
    <div class="min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-30 border-b border-gray-200 transition-all">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button id="main-back-btn" class="hidden mr-2 sm:mr-3 p-2 text-gray-500 hover:text-primary-600 hover:bg-gray-100 rounded-full transition" title="Regresar al Inicio"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" /></svg></button>
                    <span class="text-xl sm:text-2xl font-bold text-gray-900 truncate">ToolCrib <span class="text-primary-600">Requisiciones</span></span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span id="user-email-display" class="text-sm text-gray-500 hidden md:inline-block font-medium"></span>
                    <button id="btn-login-icon" class="text-gray-400 hover:text-primary-600 transition p-2 rounded-full hover:bg-gray-100" title="Acceso Admin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" /></svg></button>
                    <button id="btn-logout" class="hidden px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition">Salir</button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl w-full mx-auto p-4 sm:p-6 lg:p-8">
            
            <div id="home-screen" class="screen-content animate-fade-in">
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-gray-100 text-center sm:text-left">
                    <h1 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">Centro de Control</h1>
                    <p class="mt-2 text-lg text-gray-600">Selecciona una operaci칩n para comenzar.</p>
                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-5">
                        <button data-navigate-to="registrar-screen" class="p-6 bg-primary-600 rounded-xl shadow-lg text-white hover:bg-primary-700 transition transform hover:-translate-y-1 flex flex-col items-start"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 mb-3 opacity-80"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg><span class="text-xl font-bold">Nueva Requisici칩n</span><span class="text-primary-200 text-sm mt-1 text-left">Crear solicitud de material.</span></button>
                        <button data-navigate-to="consultar-screen" class="p-6 bg-white rounded-xl shadow-md border border-gray-200 hover:border-primary-500 transition transform hover:-translate-y-1 flex flex-col items-start group"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 mb-3 text-gray-400 group-hover:text-primary-500 transition"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 1.875 1.875v12.75a1.875 1.875 0 0 1-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V6.375a1.875 1.875 0 0 1 1.875-1.875Z" /></svg><span class="text-xl font-bold text-gray-900">Historial</span><span class="text-gray-500 text-sm mt-1 text-left">Consultar estatus de solicitudes.</span></button>
                        <button data-navigate-to="catalogo-screen" class="p-6 bg-white rounded-xl shadow-md border border-gray-200 hover:border-primary-500 transition transform hover:-translate-y-1 flex flex-col items-start group"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 mb-3 text-gray-400 group-hover:text-primary-500 transition"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25-9 5.25m18 0-9 5.25-9-5.25m18 0V21l-9 5.25-9-5.25V7.5m18 0V21l-9 5.25-9-5.25V7.5" /></svg><span class="text-xl font-bold text-gray-900">Cat치logo</span><span class="text-gray-500 text-sm mt-1 text-left">Ver productos e im치genes.</span></button>
                        <button id="btn-admin-home" data-navigate-to="admin-screen" class="hidden p-6 bg-gray-800 rounded-xl shadow-md text-white hover:bg-gray-900 transition transform hover:-translate-y-1 flex flex-col items-start"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 mb-3 opacity-80"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg><span class="text-xl font-bold">Administraci칩n</span><span class="text-gray-300 text-sm mt-1 text-left">Gestionar base de datos.</span></button>
                    </div>
                </div>
            </div>

            <div id="registrar-screen" class="screen-content hidden animate-fade-in">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Crear Nueva Requisici칩n</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col gap-8">
                        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-gray-100">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">1. Datos del Solicitante</h2>
                            <form id="form-registrar" class="space-y-5">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label><input type="text" id="reg-fecha" readonly class="bg-gray-100 w-full rounded-lg border-gray-300 text-gray-500 cursor-not-allowed"></div>
                                    <div><label class="block text-sm font-medium text-primary-700 mb-1"># Requisici칩n</label><input type="text" id="reg-num-requi" required placeholder="Ej. REQ-001" class="border-primary-300 focus:ring-primary-500 focus:border-primary-500 w-full rounded-lg shadow-sm"></div>
                                </div>
                                <div class="relative">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Empleado</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                                        <input type="text" id="reg-emp-search" autocomplete="off" placeholder="Buscar..." class="pl-10 focus:ring-primary-500 focus:border-primary-500 w-full rounded-lg border-gray-300 shadow-sm transition-colors">
                                        <button type="button" id="btn-clear-emp" class="hidden absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-red-500 transition"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg></button>
                                    </div>
                                    <div id="reg-emp-results" class="hidden absolute z-20 mt-1 w-full bg-white shadow-xl max-h-60 rounded-lg py-1 border border-gray-100 overflow-auto"></div>
                                    <input type="hidden" id="reg-selected-emp-id"><input type="hidden" id="reg-selected-emp-name">
                                </div>
                            </form>
                        </div>
                        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-gray-100">
                             <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-900 flex items-center"><svg class="w-5 h-5 mr-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.681 4.062a.75.75 0 0 0 .564.41l4.47.652c.817.119 1.147 1.114.545 1.695l-3.235 3.152a.75.75 0 0 0-.216.66l.764 4.452c.138.809-.71.1.428-1.09l-3.996-2.1a.75.75 0 0 0-.69 0l-3.996 2.1c-.71.378-1.567-.281-1.428-1.09l.764-4.452a.75.75 0 0 0-.216-.66L.64 9.703c-.602-.581-.272-1.576.545-1.695l4.47-.652a.75.75 0 0 0 .564-.41L9.132 2.884Z" clip-rule="evenodd" /></svg>Listas R치pidas</h2><select id="reg-list-select" class="text-sm rounded-lg border-gray-300 focus:ring-primary-500 focus:border-primary-500"></select></div><div id="lista-diarios" class="h-96 overflow-y-auto border rounded-lg bg-gray-50 p-2 divide-y divide-gray-200"></div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-8">
                        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-gray-100">
                             <h2 class="text-xl font-bold text-gray-900 mb-6">3. Todos los Art칤culos</h2><div class="relative mb-2"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div><input type="search" id="search-reg-articulo" class="pl-10 w-full border-gray-300 rounded-lg" placeholder="Buscar art칤culo..."></div><div id="filtros-reg-articulo" class="flex flex-wrap gap-2 mb-4 py-2 overflow-x-auto"></div><div id="lista-reg-articulo" class="h-96 overflow-y-auto border rounded-lg bg-gray-50 p-2 divide-y divide-gray-200"></div>
                        </div>
                        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-gray-100">
                             <h2 class="text-xl font-bold text-gray-900 mb-3">4. Resumen (<span id="cesta-conteo">0</span>)</h2><div class="h-40 overflow-y-auto border rounded-lg bg-white mb-6"><div id="cesta-placeholder" class="p-4 text-center text-gray-400 italic">A칰n no has agregado art칤culos.</div><div id="cesta-articulos" class="p-2 divide-y divide-gray-100 hidden"></div></div><button id="btn-registrar-submit" class="btn btn-primary w-full py-3 text-base font-bold shadow-lg hover:bg-primary-700 transition-all transform hover:-translate-y-0.5">Registrar Requisici칩n(es)</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="consultar-screen" class="screen-content hidden animate-fade-in">
                 <div class="bg-white sm:rounded-2xl shadow-sm border-y sm:border border-gray-100 overflow-hidden -mx-4 sm:mx-0"><div class="p-4 sm:p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4"><h2 class="text-xl font-bold text-gray-900">Historial de Requisiciones</h2><div class="relative w-full sm:w-72"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div><input type="search" id="search-input" class="pl-10 w-full border-gray-300 rounded-lg" placeholder="Buscar..."></div></div><div class="sm:p-0 pt-4"><table class="responsive-table min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"># Requi</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Art칤culos</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estatus</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cobro</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden col-acciones">Acciones</th></tr></thead><tbody id="tbody-requisiciones" class="bg-white sm:divide-y divide-gray-200"></tbody></table></div></div>
            </div>

             <div id="catalogo-screen" class="screen-content hidden animate-fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-2xl font-bold text-gray-900">Cat치logo de Productos</h2><div class="flex w-full sm:w-auto items-center gap-4"><div class="flex items-center border border-gray-300 rounded-lg p-0.5 bg-gray-100"><button id="btn-view-grid" class="btn-view active p-2 rounded-md" title="Vista de Galer칤a"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4.25 2A2.25 2.25 0 0 0 2 4.25v2.5A2.25 2.25 0 0 0 4.25 9h2.5A2.25 2.25 0 0 0 9 6.75v-2.5A2.25 2.25 0 0 0 6.75 2h-2.5ZM2 13.25A2.25 2.25 0 0 1 4.25 11h2.5A2.25 2.25 0 0 1 9 13.25v2.5A2.25 2.25 0 0 1 6.75 18h-2.5A2.25 2.25 0 0 1 2 15.75v-2.5ZM13.25 2A2.25 2.25 0 0 0 11 4.25v2.5A2.25 2.25 0 0 0 13.25 9h2.5A2.25 2.25 0 0 0 18 6.75v-2.5A2.25 2.25 0 0 0 15.75 2h-2.5ZM11 13.25A2.25 2.25 0 0 1 13.25 11h2.5A2.25 2.25 0 0 1 18 13.25v2.5A2.25 2.25 0 0 1 15.75 18h-2.5A2.25 2.25 0 0 1 11 15.75v-2.5Z"/></svg></button><button id="btn-view-list" class="btn-view p-2 rounded-md" title="Vista de Lista"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4.75A.75.75 0 0 1 2.75 4h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75ZM2 9.75A.75.75 0 0 1 2.75 9h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 9.75ZM2 14.75A.75.75 0 0 1 2.75 14h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 14.75Z"/></svg></button></div><div class="relative flex-grow sm:w-72"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div><input type="search" id="search-catalogo" class="pl-10 w-full border-gray-300 rounded-lg" placeholder="Buscar..."></div></div></div><div class="mb-4"><label class="text-sm font-medium text-gray-700 mr-2">Filtrar por Lista:</label><div id="catalogo-list-filtros" class="inline-flex flex-wrap gap-2"></div></div><div class="mb-6"><label class="text-sm font-medium text-gray-700 mr-2">Filtrar por Categor칤a:</label><div id="catalogo-filtros" class="inline-flex flex-wrap gap-2"></div></div><div id="catalogo-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div>
            </div>

            <div id="admin-screen" class="screen-content hidden animate-fade-in">
                <div id="admin-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col relative overflow-hidden group h-96">
                        <div class="absolute -right-6 -top-6 text-gray-50 opacity-50 group-hover:opacity-100 transition duration-700 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-32 h-32"><path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.035-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.035.84-1.875 1.875-1.875h.75c1.035 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.035.84-1.875 1.875-1.875h.75c1.035 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" /></svg>
                        </div>
                        <div class="text-center z-10 flex-shrink-0">
                            <h2 class="text-lg font-bold text-gray-900 flex items-center justify-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-primary-600"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" /></svg>
                                Rendimiento
                            </h2>
                            <div class="text-4xl font-extrabold text-primary-600 tracking-tight" id="stats-total">0</div>
                            <div class="text-xs text-gray-400 font-medium uppercase tracking-widest mb-3">Visitas Totales</div>
                            <div class="flex justify-center gap-4 text-xs text-gray-500 mb-4 border-b border-gray-100 pb-3">
                                <div><span class="font-bold text-gray-800 text-sm" id="stats-qr">0</span> 游님 QR</div>
                                <div class="border-l border-gray-200 pl-4"><span class="font-bold text-gray-800 text-sm" id="stats-direct">0</span> 游눹 Web</div>
                            </div>
                        </div>
                        <div class="flex-grow z-10 overflow-hidden flex flex-col">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 flex justify-between items-center">
                                <span>칔ltima Actividad</span>
                                <span class="text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full animate-pulse">Live</span>
                            </h3>
                            <div id="stats-recent-logs" class="space-y-2 text-xs overflow-y-auto pr-1 flex-grow scrollbar-thin">
                                <div class="text-gray-400 italic text-center pt-2">Esperando actividad...</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:col-span-2 lg:col-span-2 min-h-[500px]">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 id="art-form-title" class="text-lg font-bold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>Cat치logo Art칤culos</h2>
                            <div class="relative w-full sm:w-72">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                                <input type="search" id="admin-art-search" class="pl-10 w-full border-gray-300 rounded-lg text-sm" placeholder="Buscar para editar...">
                            </div>
                        </div>

                        <form id="form-add-articulo" class="flex flex-col gap-3 mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <input type="hidden" id="admin-art-original-num">
                            <div class="flex gap-3">
                                <div class="w-1/3"><label class="text-xs font-bold text-gray-500 uppercase ml-1">No. Parte</label><input type="text" id="admin-art-num" placeholder="Ej. 123-ABC" required class="w-full rounded-lg border-gray-300 focus:ring-primary-500 focus:border-primary-500"></div>
                                <div class="w-2/3"><label class="text-xs font-bold text-gray-500 uppercase ml-1">Descripci칩n</label><input type="text" id="admin-art-nom" placeholder="Descripci칩n" required class="w-full rounded-lg border-gray-300 focus:ring-primary-500 focus:border-primary-500"></div>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-1/2"><label class="text-xs font-bold text-gray-500 uppercase ml-1">Categor칤a</label><select id="admin-art-cat" required class="w-full rounded-lg border-gray-300 text-sm focus:ring-primary-500"><option value="">Seleccione Categor칤a...</option></select></div>
                                <div class="w-1/2"><label class="text-xs font-bold text-gray-500 uppercase ml-1">Precio ($)</label><input type="number" id="admin-art-precio" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border-gray-300 text-sm"></div>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-full"><label class="text-xs font-bold text-gray-500 uppercase ml-1">Imagen (URL)</label><input type="text" id="admin-art-img" placeholder="https://..." class="w-full rounded-lg border-gray-300 focus:ring-primary-500 focus:border-primary-500"></div>
                            </div>

                            <div class="border-t border-gray-200 pt-3 mt-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="checkbox" id="admin-art-hasVariants" class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500">
                                    <label for="admin-art-hasVariants" class="text-sm font-bold text-gray-700">Tiene Variantes (Tallas/Tipos)</label>
                                </div>
                                <div id="admin-variants-panel" class="hidden bg-white p-3 rounded-lg border border-gray-300 shadow-inner">
                                    <div class="flex justify-between text-xs font-bold text-gray-400 mb-2 px-1">
                                        <span class="w-1/2">Nombre (Ej. Talla 32)</span>
                                        <span class="w-1/2">C칩digo (Ej. BTA-T32)</span>
                                        <span class="w-6"></span>
                                    </div>
                                    <div id="variants-list-container" class="space-y-2"></div>
                                    <button type="button" onclick="window.addVariantRow()" class="mt-3 w-full py-1.5 text-xs font-bold text-primary-600 border border-dashed border-primary-300 rounded hover:bg-primary-50 flex items-center justify-center gap-1 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Agregar Variante
                                    </button>
                                </div>
                            </div>

                            <div class="mt-2"><label class="block text-sm font-medium text-gray-700 mb-2">Asignar a Listas R치pidas:</label><div id="admin-art-lists" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-24 overflow-y-auto border rounded-lg p-3 bg-white"></div></div>
                            <div class="flex gap-3 mt-4 border-t border-gray-200 pt-4">
                                <button type="button" id="btn-cancel-art" class="hidden btn btn-secondary flex-shrink-0" title="Cancelar Edici칩n">Cancelar</button>
                                <button type="submit" class="btn btn-primary flex-1 font-bold shadow-md" title="Guardar">Guardar Art칤culo</button>
                            </div>
                        </form>
                        
                        <div id="admin-list-articulos" class="flex-grow h-64 overflow-y-auto border rounded-lg bg-white p-1"></div>
                    </div>

                    <div class="flex flex-col gap-8 h-96">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 h-1/2 flex flex-col">
                            <h2 class="text-lg font-bold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z" /></svg>Categor칤as</h2>
                            <form id="form-add-categoria" class="flex gap-2 mb-2"><input type="text" id="admin-cat-name" placeholder="Nueva Categor칤a" class="w-full rounded-lg text-sm"><button class="btn btn-primary flex-shrink-0 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button></form>
                            <div id="admin-list-categorias" class="flex-grow overflow-y-auto border rounded-lg bg-gray-50 p-1 divide-y text-sm"></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-1/2">
                            <h2 class="text-lg font-bold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.362c.518 0 .73.684.34 1.002l-4.34 3.161a.562.562 0 0 0-.18.618l2.125 5.111a.563.563 0 0 1-.84.622l-4.34-3.161a.563.563 0 0 0-.65 0l-4.34 3.161a.563.563 0 0 1-.84-.622l2.125-5.111a.563.563 0 0 0-.18-.618l-4.34-3.161a.563.563 0 0 1 .34-1.002h5.362a.563.563 0 0 0 .475-.31l2.125-5.111Z" /></svg>Listas R치pidas</h2>
                            <form id="form-add-list" class="flex gap-2 mb-2"><input type="text" id="admin-list-name" placeholder="Nueva Lista R치pida" class="w-full rounded-lg text-sm"><button class="btn btn-primary flex-shrink-0 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button></form>
                            <div id="admin-list-lists" class="flex-grow overflow-y-auto border rounded-lg bg-gray-50 p-1 divide-y text-sm"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-96">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 id="emp-form-title" class="text-lg font-bold flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>Empleados</h2>
                            <div class="flex gap-2 w-full sm:w-auto"><input type="file" id="file-upload-emp" accept=".xlsx, .csv" class="hidden"><button onclick="document.getElementById('file-upload-emp').click()" class="flex-1 sm:flex-none px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Cargar</button></div>
                        </div>
                        <form id="form-add-empleado" class="flex gap-3 mb-6"><input type="number" id="admin-emp-id" placeholder="ID" required class="w-1/3 rounded-lg"><input type="text" id="admin-emp-nombre" placeholder="Nombre" required class="w-full rounded-lg"><button type="button" id="btn-cancel-emp" class="btn btn-secondary flex-shrink-0 hidden" title="Cancelar Edici칩n"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button><button type="submit" class="btn btn-primary flex-shrink-0" title="Guardar"><svg id="emp-submit-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"></svg></button></form>
                        <div id="admin-list-empleados" class="flex-grow overflow-y-auto border rounded-lg bg-gray-50 p-1 divide-y"></div>
                    </div>
                </div>
            </div>

            <div id="login-modal" class="modal hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 transform transition-all scale-95 opacity-0 text-center">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Acceso Admin</h2>
                    <form id="form-login" class="space-y-4 text-left">
                        <div><label class="text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 w-full rounded-lg"></div>
                        <div><label class="text-sm font-medium text-gray-700">Contrase침a</label><input type="password" id="login-pass" required class="mt-1 w-full rounded-lg"></div>
                        <button type="submit" id="btn-login-submit" class="btn btn-primary w-full mt-6 py-3">Entrar</button>
                    </form>
                    <button type="button" data-dismiss="modal" class="w-full text-center text-gray-500 text-sm mt-4 hover:text-gray-700">Cancelar</button>
                </div>
            </div>
            <div id="status-modal" class="modal hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                <div class="modal-content bg-white rounded-xl p-6 w-full max-w-xs text-center transform transition-all scale-95 opacity-0">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Cambiar Estatus</h3>
                    <div class="space-y-2">
                        <button id="btn-status-auth" class="w-full p-3 rounded-lg bg-green-50 text-green-700 font-medium hover:bg-green-100 transition">Autorizada</button>
                        <button id="btn-status-cob" class="w-full p-3 rounded-lg bg-blue-50 text-blue-700 font-medium hover:bg-blue-100 transition">Cobrada</button>
                        <button id="btn-status-pen" class="w-full p-3 rounded-lg bg-yellow-50 text-yellow-700 font-medium hover:bg-yellow-100 transition">Pendiente</button>
                    </div>
                    <button data-dismiss="modal" class="mt-4 text-gray-400 hover:text-gray-600 text-sm">Cancelar</button>
                </div>
            </div>
            <div id="confirm-modal" class="modal hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                <div class="modal-content bg-white rounded-xl p-6 w-full max-w-sm text-center transform transition-all scale-95 opacity-0">
                    <h3 id="confirm-title" class="text-lg font-bold text-gray-900">쮼st치s seguro?</h3>
                    <p id="confirm-message" class="text-gray-500 text-sm mt-2 mb-6"></p>
                    <div class="flex gap-3"><button onclick="closeModal('confirm-modal')" class="btn btn-secondary flex-1">No, cancelar</button><button id="btn-confirm-ok" class="btn btn-danger flex-1">S칤, eliminar</button></div>
                </div>
            </div>
            <div id="item-details-modal" class="modal hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-95 opacity-0">
                    <h2 id="item-details-title" class="text-xl font-bold mb-5 text-gray-900">Detalles del Art칤culo</h2>
                    <div class="space-y-4">
                        <div id="variant-container" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-1">Talla / Variante</label><select id="variant-select" class="focus:ring-primary-500 w-full rounded-lg"><option value="">Seleccione...</option></select></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                            <div class="flex items-center gap-2"><button type="button" id="btn-qty-minus" class="btn btn-secondary p-2.5 rounded-lg leading-none flex-shrink-0" aria-label="Restar uno"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M4 10a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H4.75A.75.75 0 0 1 4 10Z" clip-rule="evenodd" /></svg></button><input type="number" id="item-qty" value="1" min="1" class="focus:ring-primary-500 w-full rounded-lg text-center font-bold"><button type="button" id="btn-qty-plus" class="btn btn-secondary p-2.5 rounded-lg leading-none flex-shrink-0" aria-label="Sumar uno"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg></button></div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6"><button type="button" data-dismiss="modal" class="btn btn-secondary">Cancelar</button><button type="button" id="btn-item-details-submit" class="btn btn-primary px-8">Aceptar</button></div>
                    </div>
                </div>
            </div>
            <div id="req-details-modal" class="modal hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-95 opacity-0">
                    <h2 id="req-details-title" class="text-2xl font-bold mb-4 text-gray-900">Detalles de Requisici칩n</h2>
                    <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                        <div><span class="font-medium text-gray-500 block"># Requisici칩n</span><span id="req-details-num" class="font-bold"></span></div>
                        <div><span class="font-medium text-gray-500 block">Fecha</span><span id="req-details-fecha" class="font-bold"></span></div>
                        <div><span class="font-medium text-gray-500 block">Empleado</span><span id="req-details-emp" class="font-bold"></span></div>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Art칤culos</h3>
                    <div id="req-details-list" class="h-64 overflow-y-auto border rounded-lg bg-gray-50 p-2 divide-y divide-gray-200"></div>
                    <div class="flex justify-end mt-6"><button type="button" data-dismiss="modal" class="btn btn-secondary">Cerrar</button></div>
                </div>
            </div>
            <div id="qr-modal" class="modal hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-95 opacity-0 text-center">
                    <h2 class="text-xl font-bold mb-2 text-gray-900">C칩digo QR de Categor칤a</h2>
                    <p id="qr-category-name" class="text-primary-600 font-medium mb-4 text-lg"></p>
                    <div class="bg-white p-4 border-2 border-dashed border-gray-300 rounded-xl inline-block mb-6"><div id="qrcode-container"></div></div>
                    <div class="flex flex-col gap-3"><button onclick="imprimirQR()" class="btn btn-primary w-full flex items-center justify-center gap-2">Imprimir Etiqueta</button><button onclick="closeModal('qr-modal')" class="btn btn-secondary w-full">Cerrar</button></div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, setDoc, increment, getDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INICIO DE CONFIGURACI칍N ---
        const app = initializeApp({ apiKey: "AIzaSyDahnSPvBNTYot00JCn5CBjggAYFVGhbjE", authDomain: "panel-logistica-simple.firebaseapp.com", projectId: "panel-logistica-simple", storageBucket: "panel-logistica-simple.firebasestorage.app", messagingSenderId: "528779971851", appId: "1:528779971851:web:29ed933e7c7fd997a4e60e" });
        const auth = getAuth(app); const db = getFirestore(app);
        const colReqs = collection(db, 'requi_toolcrib', 'data', 'requisitions');
        const colEmps = collection(db, 'requi_toolcrib', 'data', 'employees');
        const colArts = collection(db, 'requi_toolcrib', 'data', 'articles');
        const colCats = collection(db, 'requi_toolcrib', 'data', 'categories');
        const colLists = collection(db, 'requi_toolcrib', 'data', 'lists');
        
        // --- VARIABLES GLOBALES ---
        let currentUser = null, currentReqId = null, confirmAction = null, reqsData = [], empsMap = new Map(), artsMap = new Map();
        let catsMap = new Map(), listsMap = new Map();
        let currentCategory = 'Todos', currentRegCategory = 'Todos', catalogoViewMode = 'grid';
        let currentListFilterId = 'Todos', currentRegListId = 'Todos';
        let articulosSeleccionados = []; let currentItemForDetails = null;
        const PLACEHOLDER_IMG = "https://placehold.co/400x400/f1f5f9/94a3b8?text=Sin+Imagen";
        let editingEmpId = null, editingArtId = null; 
        const iconAddSVG = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>';
        const iconEditSVG = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>';

        // --- FUNCIONES NUEVAS PARA VARIANTES ---
        window.addVariantRow = (name = '', code = '') => {
            const container = document.getElementById('variants-list-container');
            if (container) {
                const row = document.createElement('div');
                row.className = 'variant-row';
                row.innerHTML = `<input type="text" placeholder="Ej. Talla 32" value="${name}" class="variant-name-input variant-input"><input type="text" placeholder="Ej. BTA-T32" value="${code}" class="variant-code-input variant-input"><button type="button" onclick="this.parentElement.remove()" class="variant-btn-del"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>`;
                container.appendChild(row);
            }
        };
        const getVariantsData = () => {
            const arr = []; 
            document.querySelectorAll('.variant-row').forEach(row => {
                const n = row.querySelector('.variant-name-input').value.trim();
                const c = row.querySelector('.variant-code-input').value.trim();
                if(n && c) arr.push({name:n, code:c});
            }); 
            return arr;
        };

        // --- FUNCIONES UTILITARIAS (Modales, Toasts) ---
        const showToast = (msg, type = 'success') => {
            const t = document.createElement('div'); t.className = `toast toast-${type}`;
            t.innerHTML = `<div class="${type==='success'?'text-green-500':type==='error'?'text-red-500':'text-blue-500'} mr-3"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div><div class="text-sm font-medium">${msg}</div>`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => { t.classList.add('hiding'); setTimeout(() => t.remove(), 300) }, 3000);
        };
        const openModal = (id) => { const m = document.getElementById(id); if(m) { m.classList.remove('hidden'); setTimeout(() => { m.querySelector('.modal-content').classList.remove('scale-95','opacity-0'); }, 10); }};
        window.closeModal = (id) => { const m = document.getElementById(id); if(m) { m.querySelector('.modal-content').classList.add('scale-95','opacity-0'); setTimeout(() => m.classList.add('hidden'), 200); }};
        const askConfirm = (title, msg, action) => { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-message').innerText = msg; confirmAction = action; openModal('confirm-modal'); };
        
        // --- FUNCIONES DE ALCANCE LOCAL (para setStatus y copyToClipboard) ---
        const setStatus = async (newStatus) => {
            if (!currentReqId || !currentUser) return;
            const docIdToUpdate = currentReqId;
            try {
                const updateData = { status: newStatus };
                if (newStatus === 'Cobrada') { updateData.fechaCobro = new Date().toISOString().split('T')[0]; } else { updateData.fechaCobro = null; }
                await updateDoc(doc(colReqs, docIdToUpdate), updateData);
                showToast(`Estatus: ${newStatus}`);
                closeModal('status-modal');
                const itemIndex = reqsData.findIndex(r => r.id === docIdToUpdate);
                if (itemIndex > -1) {
                    reqsData[itemIndex].status = newStatus;
                    reqsData[itemIndex].fechaCobro = updateData.fechaCobro || null;
                }
                const modal = document.getElementById('req-details-modal');
                if (!modal.classList.contains('hidden')) {
                    const reqId = reqsData[itemIndex].numRequi;
                    refreshReqDetailsModal(reqId);
                }
                renderReqs();
            } catch (e) { console.error(e); showToast('Error al actualizar', 'error'); }
        };
        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => { showToast('Copiado: ' + text, 'info'); })
            .catch(err => {
                const textArea = document.createElement("textarea"); textArea.value = text;
                document.body.appendChild(textArea); textArea.select();
                try { document.execCommand('copy'); showToast('Copiado: ' + text, 'info'); } catch (err) { showToast('No se pudo copiar', 'error'); }
                document.body.removeChild(textArea);
            });
        };
        
        // --- NAVEGACI칍N ---
        const navigateTo = (screenId) => {
            document.querySelectorAll('.screen-content').forEach(s => s.classList.add('hidden'));
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.remove('hidden');
            const backBtn = document.getElementById('main-back-btn');
            if(backBtn) backBtn.classList.toggle('hidden', screenId === 'home-screen');
            if (screenId === 'registrar-screen') {
                document.getElementById('form-registrar').reset();
                document.getElementById('reg-fecha').value = new Date().toISOString().split('T')[0];
                articulosSeleccionados = []; currentRegCategory = 'Todos'; currentRegListId = 'Todos';
                renderRegistrarListArticles(); renderRegistrarArticulos(); renderCestaArticulos(); renderDynamicCategoryUI(); 
            }
            if (screenId === 'catalogo-screen') { currentListFilterId = 'Todos'; renderDynamicCategoryUI(); }
        };

        // --- L칍GICA DE FIRESTORE (LISTENERS) ---
        onAuthStateChanged(auth, (u) => {
            currentUser = u;
            const btnLoginIcon = document.getElementById('btn-login-icon');
            const btnLogout = document.getElementById('btn-logout');
            const btnAdminHome = document.getElementById('btn-admin-home');
            
            if (btnLoginIcon) btnLoginIcon.classList.toggle('hidden', !!u);
            if (btnLogout) btnLogout.classList.toggle('hidden', !u);
            if (btnAdminHome) btnAdminHome.classList.toggle('hidden', !u);

            if(u) {
                document.getElementById('user-email-display').innerText = u.email;
                loadKPIs();
            } else {
                if(!document.getElementById('admin-screen').classList.contains('hidden')) navigateTo('home-screen');
            }
            document.querySelectorAll('.col-acciones').forEach(e => e.classList.toggle('hidden', !u));
            renderReqs(); renderAdmin(); renderCatalogo();
        });

        // 2. Listeners de Datos
        onSnapshot(colReqs, (s) => { reqsData = []; s.forEach(d => reqsData.push({id: d.id, ...d.data()})); renderReqs(); }, (e) => { if(e.code==='permission-denied') document.getElementById('tbody-requisiciones').innerHTML='<tr><td colspan="7" class="p-8 text-center text-gray-500">Inicia sesi칩n para ver datos.</td></tr>'; });
        onSnapshot(colEmps, (s) => { empsMap.clear(); s.forEach(d => empsMap.set(d.data().id, {...d.data(), fbId: d.id})); renderAdmin(); });
        onSnapshot(colArts, (s) => { artsMap.clear(); s.forEach(d => artsMap.set(d.data().num, {...d.data(), fbId: d.id})); renderAdmin(); renderCatalogo(); renderRegistrarArticulos(); renderRegistrarListArticles(); });
        onSnapshot(colCats, (s) => { catsMap.clear(); const sel = document.getElementById('admin-art-cat'); if(sel) { sel.innerHTML = '<option value="">Selecciona...</option>'; s.forEach(d => { catsMap.set(d.data().name, d.id); sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`; }); } renderDynamicCategoryUI(); });
        onSnapshot(colLists, (s) => { listsMap.clear(); s.forEach(d => listsMap.set(d.id, { name: d.data().name, fbId: d.id })); renderDynamicCategoryUI(); renderAdminLists(); renderRegistrarListDropdown(); });

        // --- KPI & LOGS ---
        function loadKPIs() {
            onSnapshot(doc(db, 'requi_toolcrib', 'stats'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const totalEl = document.getElementById('stats-total'); if (totalEl) totalEl.innerText = (data.totalVisits || 0).toLocaleString();
                    const qrEl = document.getElementById('stats-qr'); if(qrEl) qrEl.innerText = (data.sources?.qr || 0).toLocaleString();
                    const dirEl = document.getElementById('stats-direct'); if(dirEl) dirEl.innerText = (data.sources?.direct || 0).toLocaleString();
                }
            });
            const logsQuery = query(collection(db, 'requi_toolcrib', 'data', 'traffic_logs'), orderBy('timestamp', 'desc'), limit(10));
            onSnapshot(logsQuery, (snapshot) => {
                const logsContainer = document.getElementById('stats-recent-logs');
                if (logsContainer) {
                    if (snapshot.empty) logsContainer.innerHTML = '<div class="text-gray-400 italic text-center pt-4">Sin actividad reciente.</div>';
                    else logsContainer.innerHTML = snapshot.docs.map(doc => {
                        const log = doc.data(); const isQR = log.tipo === 'QR'; const icon = isQR ? '游님' : '游눹';
                        const timeStr = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : log.hora;
                        const dateStr = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleDateString([], {day: '2-digit', month:'2-digit'}) : log.fecha;
                        return `<div class="flex items-start gap-2 border-b border-gray-200 last:border-0 pb-1 mb-1"><div class="text-base">${icon}</div><div class="flex-grow"><div class="flex justify-between"><span class="font-bold text-gray-700">${log.categoria}</span><span class="text-[10px] text-gray-400">${dateStr} ${timeStr}</span></div><div class="text-[10px] text-gray-500">${isQR ? 'Escaneo QR' : 'Acceso Web'}</div></div></div>`;
                    }).join('');
                }
            });
        }

        async function registrarTrafico(categoriaQR = null) {
            const statsRef = doc(db, 'requi_toolcrib', 'stats'); const logsRef = collection(db, 'requi_toolcrib', 'data', 'traffic_logs'); const ahora = new Date();
            try {
                await setDoc(statsRef, { lastUpdateCheck: ahora.toISOString() }, { merge: true });
                const updates = { totalVisits: increment(1), lastVisit: ahora.toISOString() };
                if (categoriaQR) { updates[`scans.${categoriaQR}`] = increment(1); updates['sources.qr'] = increment(1); } else { updates['sources.direct'] = increment(1); }
                await updateDoc(statsRef, updates);
                await addDoc(logsRef, { timestamp: ahora, fecha: ahora.toLocaleDateString('es-MX'), hora: ahora.toLocaleTimeString('es-MX'), tipo: categoriaQR ? 'QR' : 'Directo', categoria: categoriaQR || 'N/A', device: navigator.userAgent });
            } catch (error) { console.error("Error registrando tr치fico:", error); }
        }

        // --- RENDERIZADO DEL HISTORIAL ---
        function renderReqs() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = reqsData.filter(r => (r.nombre||'').toLowerCase().includes(term) || (r.empleadoId||'').toString().includes(term) || (r.articulo||'').toLowerCase().includes(term) || (r.numRequi||'').toLowerCase().includes(term));
            const reqGroups = new Map();
            for (const r of filtered) {
                if (!r.numRequi) continue;
                if (!reqGroups.has(r.numRequi)) { reqGroups.set(r.numRequi, { numRequi: r.numRequi, fecha: r.fecha, empleadoId: r.empleadoId, nombre: r.nombre, items: [], statuses: new Set() }); }
                const group = reqGroups.get(r.numRequi); group.items.push(r); group.statuses.add(r.status);
            }
            const tbody = document.getElementById('tbody-requisiciones');
            if (reqGroups.size === 0) { tbody.innerHTML = `<tr><td colspan="7" class="p-12 text-center text-gray-400 italic">Sin resultados en el historial.</td></tr>`; return; }
            tbody.innerHTML = Array.from(reqGroups.values()).sort((a,b) => b.fecha.localeCompare(a.fecha)).map(group => {
                let statusHtml = '';
                const getStatusBadge = (status, itemId) => {
                    const colors = { 'Autorizada': 'bg-green-100 text-green-700 border-green-200', 'Cobrada': 'bg-blue-100 text-blue-700 border-blue-200', 'Pendiente': 'bg-yellow-50 text-yellow-700 border-yellow-200' };
                    const css = colors[status] || 'bg-gray-100 text-gray-600 border-gray-200';
                    const interactive = currentUser ? 'cursor-pointer hover:shadow-sm hover:scale-105 active:scale-95' : '';
                    return `<span class="status-badge-modal ${interactive} transition-all inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold border ${css}" data-doc-id="${itemId}"><span class="w-1.5 h-1.5 rounded-full bg-current mr-1.5 opacity-50"></span>${status}</span>`;
                };
                if (group.items.length === 1) statusHtml = getStatusBadge(group.items[0].status, group.items[0].id);
                else if (group.statuses.size === 1) statusHtml = getStatusBadge(group.statuses.values().next().value, null);
                else statusHtml = `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600 border border-gray-200">Mixto</span>`;
                const articuloHtml = group.items.length > 1 ? `<button class="btn-view-req-details inline-flex items-center gap-1.5 bg-white border border-gray-300 text-gray-700 hover:text-primary-600 hover:border-primary-300 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm" data-req-id="${group.numRequi}">Ver ${group.items.length} Art칤culos</button>` : `<span class="font-medium text-gray-700 text-sm">${group.items[0]?.articulo || 'N/A'}</span>`;
                const cobroFecha = group.items.length === 1 ? (group.items[0].fechaCobro || '-') : (group.statuses.size === 1 && group.statuses.has('Cobrada') ? 'M칰ltiple' : '-');
                return `<tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0 group"><td class="px-6 py-4"><span class="font-mono text-sm font-bold text-primary-700 bg-primary-50 px-2 py-1 rounded border border-primary-100">${group.numRequi}</span></td><td class="px-6 py-4 text-sm text-gray-500 font-medium">${group.fecha}</td><td class="px-6 py-4"><div class="flex items-center"><div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-xs font-bold mr-3 border border-gray-200">${group.nombre.charAt(0)}</div><div><div class="font-bold text-gray-800 text-sm">${group.nombre}</div><div class="text-xs text-gray-400 font-mono">${group.empleadoId}</div></div></div></td><td class="px-6 py-4">${articuloHtml}</td><td class="px-6 py-4 text-center">${statusHtml}</td><td class="px-6 py-4 text-sm text-gray-500">${cobroFecha}</td><td class="px-6 py-4 text-center col-acciones ${currentUser?'':'hidden'}"><button class="btn-del-req text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition" data-req-id="${group.numRequi}" data-items-count="${group.items.length}" title="Eliminar requisici칩n completa"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></td></tr>`;
            }).join('');
        }

        function refreshReqDetailsModal(reqId) {
            const groupItems = reqsData.filter(r => r.numRequi === reqId);
            if (groupItems.length > 0) {
                document.getElementById('req-details-list').innerHTML = groupItems.map(item => {
                    const statusClass = item.status==='Autorizada'?'bg-green-100 text-green-800':item.status==='Cobrada'?'bg-blue-100 text-blue-800':'bg-yellow-100 text-yellow-800';
                    return `<div class="flex justify-between items-center p-3"><span class="text-sm font-medium text-gray-700">${item.articulo}</span><span class="status-badge-modal ${currentUser ? 'cursor-pointer hover:scale-105' : ''} transition inline-flex px-3 py-1 text-xs font-semibold rounded-full ${statusClass}" data-doc-id="${item.id}">${item.status}</span></div>`;
                }).join('');
            }
        }

        function renderAdmin() {
            // Empleados
            const empList = document.getElementById('admin-list-empleados');
            if (empList) {
                empList.innerHTML = empsMap.size ? Array.from(empsMap.values()).sort((a, b) => a.id - b.id).map(e => `<div class="flex justify-between items-center p-3 hover:bg-white transition"><div><span class="font-bold">${e.id}</span> <span class="text-gray-600 ml-2">${e.nombre}</span></div><div class="flex gap-3"><button class="btn-edit-emp text-gray-400 hover:text-blue-600 transition" data-id="${e.fbId}" data-emp-id="${e.id}" data-n="${e.nombre}" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button><button class="btn-del-emp text-gray-400 hover:text-red-600 transition" data-id="${e.fbId}" data-n="${e.nombre}" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div>`).join('') : '<div class="p-4 text-center text-gray-400 italic">Vac칤o</div>';
            }

            // Art칤culos
            const listContainer = document.getElementById('admin-list-articulos');
            const term = document.getElementById('admin-art-search').value.toLowerCase();
            let articles = Array.from(artsMap.values());
            if (term) articles = articles.filter(a => a.num.toLowerCase().includes(term) || a.nom.toLowerCase().includes(term));
            
            if (articles.length === 0) { listContainer.innerHTML = '<div class="p-8 text-center text-gray-400 italic">No se encontraron art칤culos.</div>'; return; }
            
            // Agrupar
            const grouped = {}; const officialCats = Array.from(catsMap.keys()).sort(); officialCats.forEach(cat => grouped[cat] = []);
            articles.forEach(a => { const catKey = a.cat || 'Sin Categor칤a'; if (!grouped[catKey]) grouped[catKey] = []; grouped[catKey].push(a); });

            let html = ''; const allGroupKeys = Object.keys(grouped).sort();
            allGroupKeys.forEach(catName => {
                const items = grouped[catName];
                if (items && items.length > 0) {
                    items.sort((a, b) => a.nom.localeCompare(b.nom));
                    html += `<div class="sticky top-0 bg-gray-100 px-4 py-2 font-bold text-gray-700 text-sm border-y border-gray-200 z-10 flex justify-between items-center shadow-sm"><span>${catName}</span><span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs font-bold">${items.length}</span></div>`;
                    html += items.map(a => {
                        const listNames = (a.assignedLists || []).map(listId => listsMap.get(listId)?.name).filter(Boolean).join(', ');
                        const precioDisplay = (Number(a.precio) || 0).toFixed(2);
                        const isComplex = Array.isArray(a.variants);
                        const variantsBadge = a.hasVariants ? `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-200">${isComplex ? a.variants.length + ' Variantes' : 'Variantes Simples'}</span>` : '';
                        return `<div class="flex justify-between items-center p-3 hover:bg-primary-50 transition border-b border-gray-50 last:border-0 group bg-white"><div class="flex-grow"><div class="flex items-center gap-2"><span class="font-mono text-xs sm:text-sm bg-white border border-gray-200 text-primary-700 px-2 py-0.5 rounded font-bold">${a.num}</span><span class="font-medium text-gray-800 text-sm sm:text-base">${a.nom}</span></div><div class="mt-1 flex flex-wrap gap-2 items-center"><span class="text-xs font-bold text-green-700 bg-green-50 px-2 py-0.5 rounded border border-green-100">$${precioDisplay}</span>${variantsBadge}${listNames ? `<span class="text-xs bg-yellow-50 text-yellow-600 px-2 py-0.5 rounded border border-yellow-100" title="${listNames}">En listas</span>` : ''}</div></div><div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity"><button class="btn-edit-art bg-white border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-300 p-2 rounded-lg shadow-sm transition" data-id="${a.fbId}" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button><button class="btn-del-art bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-300 p-2 rounded-lg shadow-sm transition" data-id="${a.fbId}" data-n="${a.nom}" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div>`;
                    }).join('');
                }
            });
            listContainer.innerHTML = html;
        }

        function renderCategorias() {
            const list = document.getElementById('admin-list-categorias');
            list.innerHTML = Array.from(catsMap.entries()).sort().map(([name, id]) => `<div class="flex justify-between items-center p-3 hover:bg-gray-50 border-b border-gray-100"><span>${name}</span><div class="flex gap-2"><button class="btn-qr-cat text-gray-400 hover:text-gray-900 bg-gray-50 hover:bg-gray-200 p-1.5 rounded-lg transition" data-n="${name}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" /></svg></button><button class="text-red-400 hover:text-red-600 btn-del-cat" data-id="${id}" data-n="${name}"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div>`).join('');
        }

        function renderAdminLists() {
            const list = document.getElementById('admin-list-lists');
            list.innerHTML = Array.from(listsMap.values()).sort((a, b) => a.name.localeCompare(b.name)).map(l => `<div class="flex justify-between items-center p-3 hover:bg-white transition"><span class="text-gray-700">${l.name}</span><button class="btn-del-list text-gray-400 hover:text-red-600 transition" data-id="${l.fbId}" data-n="${l.name}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div>`).join('');
        }

        function renderArticuloListsCheckboxes(assignedLists = []) {
            const container = document.getElementById('admin-art-lists');
            if (container) {
                const sortedLists = Array.from(listsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                container.innerHTML = sortedLists.length ? sortedLists.map(l => `<div class="flex items-center"><input id="list-${l.fbId}" value="${l.fbId}" type="checkbox" ${assignedLists.includes(l.fbId) ? 'checked' : ''} class="h-4 w-4 rounded text-primary-600 focus:ring-primary-500"><label for="list-${l.fbId}" class="ml-2 text-sm text-gray-700">${l.name}</label></div>`).join('') : '<div class="text-sm text-gray-400 italic">No hay listas creadas.</div>';
            }
        }

        function renderCatalogo() {
            const term = document.getElementById('search-catalogo').value.toLowerCase();
            let articles = Array.from(artsMap.values());
            if (currentListFilterId !== 'Todos') articles = articles.filter(a => a.assignedLists && a.assignedLists.includes(currentListFilterId));
            if (currentCategory !== 'Todos') articles = articles.filter(a => a.cat === currentCategory);
            if (term) articles = articles.filter(a => a.num.toLowerCase().includes(term) || a.nom.toLowerCase().includes(term));
            articles.sort((a,b) => a.nom.localeCompare(b.nom));
            
            const grid = document.getElementById('catalogo-grid');
            if(grid) {
                if (articles.length === 0) { grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center p-12 text-center"><div class="bg-gray-100 rounded-full p-4 mb-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></div><p class="text-gray-500 font-medium">No encontramos art칤culos con esa b칰squeda.</p></div>`; return; }
                if (catalogoViewMode === 'grid') {
                    grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
                    grid.innerHTML = articles.map(a => {
                        let imgSrc = a.img || PLACEHOLDER_IMG; if (a.img && !a.img.startsWith('http')) imgSrc = `./catalogo/${a.img}`;
                        const precioDisplay = (Number(a.precio) || 0).toFixed(2);
                        return `<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group flex flex-col h-full relative"><div class="aspect-w-1 bg-white relative overflow-hidden border-b border-gray-50"><img src="${imgSrc}" alt="${a.nom}" class="object-contain w-full h-full p-6 transition-transform duration-500 group-hover:scale-110" onerror="this.src='${PLACEHOLDER_IMG}'"></div><div class="p-5 flex flex-col flex-grow"><div class="mb-2 text-left"><span class="text-[10px] font-extrabold uppercase tracking-widest text-gray-400">${a.cat || 'GENERAL'}</span></div><div class="mb-3"><button class="btn-copy-part group/btn w-full flex items-center justify-center gap-2 font-mono text-base font-black text-slate-700 bg-slate-100 hover:bg-slate-200 hover:text-primary-800 hover:border-primary-300 px-3 py-2 rounded-xl border border-slate-200 transition-all active:scale-95" data-num="${a.num}"><span class="tracking-tight">${a.num}</span></button></div><h3 class="text-sm font-medium text-gray-600 leading-relaxed flex-grow text-center">${a.nom}</h3>${a.hasVariants ? `<div class="mt-4 pt-3 border-t border-dashed border-gray-100 flex items-center justify-center gap-2"><span class="text-xs font-semibold text-blue-600">Opciones</span></div>` : ''}</div></div>`;
                    }).join('');
                } else {
                     grid.className = 'flex flex-col gap-3';
                     grid.innerHTML = articles.map(a => `<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-col sm:flex-row sm:items-center gap-4 hover:border-primary-200 transition-colors group"><div class="flex-grow"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider border border-gray-200 px-1.5 py-0.5 rounded">${a.cat || 'GENERAL'}</span>${a.hasVariants ? `<span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded">VARIOS</span>` : ''}</div><div class="text-gray-800 font-medium leading-snug">${a.nom}</div></div><div class="mt-2 sm:mt-0 min-w-[180px]"><button class="btn-copy-part group/btn w-full flex items-center justify-center gap-2 font-mono text-sm font-black text-slate-700 bg-slate-50 hover:bg-slate-100 px-3 py-2 rounded-lg border border-slate-200" data-num="${a.num}"><span class="tracking-tight">${a.num}</span></button></div></div>`).join('');
                }
            }
        }

        function renderDynamicCategoryUI() {
            renderAdminCategorias(); renderArticuloCategoryDropdown();
            renderCatalogoFiltros('catalogo-filtros', currentCategory, 'btn-cat-filter');
            renderCatalogoFiltros('filtros-reg-articulo', currentRegCategory, 'btn-reg-cat-filter');
            renderCatalogoListFiltros(); renderCatalogo(); renderRegistrarArticulos(); renderRegistrarListArticles();
        }

        function renderArticuloCategoryDropdown() {
            const select = document.getElementById('admin-art-cat');
            if (select) {
                const currentValue = select.value; const sortedCats = Array.from(catsMap.keys()).sort();
                select.innerHTML = '<option value="">Seleccione Categor칤a...</option>';
                sortedCats.forEach(catName => { select.innerHTML += `<option value="${catName}">${catName}</option>`; });
                select.value = currentValue;
            }
        }
        function renderCatalogoFiltros(containerId, activeCategory, btnClass) {
             const container = document.getElementById(containerId); if (!container) return;
             const sortedCats = Array.from(catsMap.keys()).sort();
             let html = `<button data-category="Todos" class="${btnClass} px-3 py-1 text-sm font-medium rounded-full transition border">Todos</button>`;
             sortedCats.forEach(catName => { html += `<button data-category="${catName}" class="${btnClass} px-3 py-1 text-sm font-medium rounded-full transition border">${catName}</button>`; }); container.innerHTML = html;
             container.querySelectorAll(`.${btnClass}`).forEach(btn => { if (btn.dataset.category === activeCategory) { btn.classList.add('bg-primary-600', 'text-white', 'border-primary-600'); } else { btn.classList.add('bg-white', 'text-gray-600', 'hover:bg-gray-50', 'border-gray-300'); } });
        }
        function renderCatalogoListFiltros() {
            const container = document.getElementById('catalogo-list-filtros'); if (!container) return;
            const sortedLists = Array.from(listsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            let html = `<button data-list-id="Todos" class="btn-list-filter px-3 py-1 text-sm font-medium rounded-full transition border">Todas</button>`;
            sortedLists.forEach(l => { html += `<button data-list-id="${l.fbId}" class="btn-list-filter px-3 py-1 text-sm font-medium rounded-full transition border">${l.name}</button>`; }); container.innerHTML = html;
            container.querySelectorAll('.btn-list-filter').forEach(btn => { btn.classList.toggle('active', btn.dataset.listId === currentListFilterId); });
        }
        function renderRegistrarListDropdown() {
             const select = document.getElementById('reg-list-select'); if (!select) return;
             const sortedLists = Array.from(listsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
             select.innerHTML = '<option value="Todos">Mostrar Todas las Listas</option>';
             sortedLists.forEach(l => { select.innerHTML += `<option value="${l.fbId}">${l.name}</option>`; });
             select.value = currentRegListId;
        }
        function renderRegistrarListArticles() {
             const list = document.getElementById('lista-diarios'); if (!list) return;
             let items = Array.from(artsMap.values());
             if (currentRegListId === 'Todos') { items = items.filter(a => a.assignedLists && a.assignedLists.length > 0); } else { items = items.filter(a => a.assignedLists && a.assignedLists.includes(currentRegListId)); }
             items.sort((a,b) => a.nom.localeCompare(b.nom));
             if (items.length === 0) { list.innerHTML = '<div class="p-8 text-center text-gray-400 italic">Lista vac칤a.</div>'; return; }
             list.innerHTML = items.map(a => {
                  const isAdded = !a.hasVariants && articulosSeleccionados.some(art => art.num === a.num);
                  let imgSrc = a.img || PLACEHOLDER_IMG; if (a.img && !a.img.startsWith('http')) imgSrc = `./catalogo/${a.img}`;
                  return `<div class="flex items-center p-3 hover:bg-white transition border-b border-gray-100 last:border-0 group"><div class="h-12 w-12 flex-shrink-0 bg-gray-50 rounded-lg border border-gray-100 overflow-hidden mr-3"><img src="${imgSrc}" class="h-full w-full object-contain p-1"></div><div class="flex-grow min-w-0 mr-2"><div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">${a.cat || 'General'}</div><div class="font-bold text-gray-800 text-sm truncate">${a.nom}</div><div class="flex items-center gap-2 mt-1"><span class="font-mono text-xs font-bold text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${a.num}</span>${a.hasVariants ? '<span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded">Tallas</span>' : ''}</div></div><button class="btn-add-articulo flex-shrink-0 h-9 w-9 flex items-center justify-center rounded-lg transition-all shadow-sm ${isAdded ? 'bg-gray-100 text-gray-400' : 'bg-white border border-gray-200 text-primary-600 hover:bg-primary-50'}" data-num="${a.num}" data-nom="${a.nom}" data-has-variants="${a.hasVariants || false}" data-variants='${JSON.stringify(a.variants || [])}' ${isAdded ? 'disabled' : ''}>${isAdded ? '九' : '+'}</button></div>`;
             }).join('');
        }
        function renderRegistrarArticulos() {
             const list = document.getElementById('lista-reg-articulo'); if (!list) return;
             const term = document.getElementById('search-reg-articulo').value.toLowerCase();
             let articles = Array.from(artsMap.values());
             if (currentRegCategory !== 'Todos') articles = articles.filter(a => a.cat === currentRegCategory);
             if (term) articles = articles.filter(a => a.num.toLowerCase().includes(term) || a.nom.toLowerCase().includes(term));
             articles.sort((a,b) => a.nom.localeCompare(b.nom));
             if (articles.length === 0) { list.innerHTML = '<div class="p-8 text-center text-gray-400 italic">No se encontraron art칤culos.</div>'; return; }
             list.innerHTML = articles.map(a => {
                 const isAdded = !a.hasVariants && articulosSeleccionados.some(art => art.num === a.num);
                 let imgSrc = a.img || PLACEHOLDER_IMG; if (a.img && !a.img.startsWith('http')) imgSrc = `./catalogo/${a.img}`;
                 return `<div class="flex items-center p-3 hover:bg-white transition border-b border-gray-100 last:border-0 group"><div class="h-12 w-12 flex-shrink-0 bg-gray-50 rounded-lg border border-gray-100 overflow-hidden mr-3"><img src="${imgSrc}" class="h-full w-full object-contain p-1"></div><div class="flex-grow min-w-0 mr-2"><div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">${a.cat || 'General'}</div><div class="font-bold text-gray-800 text-sm truncate">${a.nom}</div><div class="flex items-center gap-2 mt-1"><span class="font-mono text-xs font-bold text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${a.num}</span>${a.hasVariants ? '<span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded">Tallas</span>' : ''}</div></div><button class="btn-add-articulo flex-shrink-0 h-9 w-9 flex items-center justify-center rounded-lg transition-all shadow-sm ${isAdded ? 'bg-gray-100 text-gray-400' : 'bg-white border border-gray-200 text-primary-600 hover:bg-primary-50'}" data-num="${a.num}" data-nom="${a.nom}" data-has-variants="${a.hasVariants || false}" data-variants='${JSON.stringify(a.variants || [])}' ${isAdded ? 'disabled' : ''}>${isAdded ? '九' : '+'}</button></div>`;
             }).join('');
        }
        function renderCestaArticulos() {
             const cesta = document.getElementById('cesta-articulos'), placeholder = document.getElementById('cesta-placeholder'), conteo = document.getElementById('cesta-conteo');
             if (!cesta) return;
             conteo.innerText = articulosSeleccionados.length;
             if (articulosSeleccionados.length === 0) { cesta.innerHTML = ''; cesta.classList.add('hidden'); placeholder.classList.remove('hidden'); }
             else {
                 cesta.classList.remove('hidden'); placeholder.classList.add('hidden');
                 cesta.innerHTML = articulosSeleccionados.map((art, index) => {
                     let imgSrc = art.img || PLACEHOLDER_IMG; if (art.img && !art.img.startsWith('http')) imgSrc = `./catalogo/${art.img}`;
                     return `<div class="flex justify-between items-center p-3 animate-fade-in hover:bg-gray-50 transition rounded-lg"><div class="flex items-center overflow-hidden"><div class="h-10 w-10 flex-shrink-0 bg-white rounded border border-gray-200 overflow-hidden mr-3"><img src="${imgSrc}" class="h-full w-full object-contain p-0.5"></div><div class="min-w-0"><div class="font-bold text-gray-800 text-sm truncate pr-2 leading-tight">${art.nom}</div><div class="flex items-center gap-2 text-xs mt-0.5"><span class="font-mono font-medium text-gray-500">${art.variantCode || art.num}</span>${art.variant ? `<span class="bg-blue-100 text-blue-700 px-1.5 rounded font-bold">${art.variant}</span>` : ''}<span class="bg-green-100 text-green-700 px-1.5 rounded font-bold">x${art.qty}</span></div></div></div><button class="btn-remove-articulo h-8 w-8 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition ml-2 flex-shrink-0" data-index="${index}" title="Quitar">x</button></div>`;
                 }).join('');
             }
             renderRegistrarArticulos();
        }
        window.removeCartItem = (i) => { articulosSeleccionados.splice(i, 1); renderCestaArticulos(); };

        // --- EVENTOS ---
        document.addEventListener('click', e => {
            const navBtn = e.target.closest('[data-navigate-to]'); if (navBtn) navigateTo(navBtn.dataset.navigateTo);
            if(e.target.closest('[data-dismiss="modal"]')) closeModal(e.target.closest('.modal').id);
            const copyBtn = e.target.closest('.btn-copy-part'); if (copyBtn) copyToClipboard(copyBtn.dataset.num);
            const delEmp = e.target.closest('.btn-del-emp'); if(delEmp && currentUser) askConfirm('Eliminar Empleado', `쮼liminar a ${delEmp.dataset.n}?`, async () => { await deleteDoc(doc(colEmps, delEmp.dataset.id)); showToast('Eliminado'); });
            const delArt = e.target.closest('.btn-del-art'); if(delArt && currentUser) askConfirm('Eliminar Art칤culo', `쮼liminar ${delArt.dataset.n}?`, async () => { await deleteDoc(doc(colArts, delArt.dataset.id)); showToast('Eliminado'); });
            const delCat = e.target.closest('.btn-del-cat'); if(delCat && currentUser) askConfirm('Eliminar Categor칤a', `쮼liminar?`, async () => { await deleteDoc(doc(colCats, delCat.dataset.id)); showToast('Eliminado'); });
            const delList = e.target.closest('.btn-del-list'); if(delList && currentUser) askConfirm('Eliminar Lista', `쮼liminar?`, async () => { await deleteDoc(doc(colLists, delList.dataset.id)); showToast('Eliminado'); });
            
            const viewReq = e.target.closest('.btn-view-req-details');
            if (viewReq) {
                 const reqId = viewReq.dataset.reqId; const groupItems = reqsData.filter(r => r.numRequi === reqId);
                 if (groupItems.length > 0) {
                     const base = groupItems[0];
                     document.getElementById('req-details-title').innerText = `Detalles: ${base.numRequi}`;
                     document.getElementById('req-details-num').innerText = base.numRequi;
                     document.getElementById('req-details-fecha').innerText = base.fecha;
                     document.getElementById('req-details-emp').innerText = `${base.empleadoId} - ${base.nombre}`;
                     refreshReqDetailsModal(reqId); openModal('req-details-modal');
                 }
            }
            const statusBadge = e.target.closest('.status-badge-modal');
            if (statusBadge && currentUser) { currentReqId = statusBadge.dataset.docId; openModal('status-modal'); }
            const delReq = e.target.closest('.btn-del-req'); 
            if(delReq && currentUser) {
                 const reqId = delReq.dataset.reqId, count = delReq.dataset.itemsCount;
                 askConfirm(`Eliminar Requisici칩n`, `쮼liminar ${count} items?`, async () => { 
                     const items = reqsData.filter(r => r.numRequi === reqId);
                     await Promise.all(items.map(i => deleteDoc(doc(colReqs, i.id))));
                     showToast('Eliminada'); 
                 });
            }

            const catBtn = e.target.closest('.btn-cat-filter'); if (catBtn) { currentCategory = catBtn.dataset.category; renderCatalogoFiltros('catalogo-filtros', currentCategory, 'btn-cat-filter'); renderCatalogo(); }
            const regCatBtn = e.target.closest('.btn-reg-cat-filter'); if (regCatBtn) { currentRegCategory = regCatBtn.dataset.category; renderCatalogoFiltros('filtros-reg-articulo', currentRegCategory, 'btn-reg-cat-filter'); renderRegistrarArticulos(); }
            const listFilterBtn = e.target.closest('.btn-list-filter'); if (listFilterBtn) { currentListFilterId = listFilterBtn.dataset.listId; renderCatalogoListFiltros(); renderCatalogo(); }

            const editEmp = e.target.closest('.btn-edit-emp'); if (editEmp) startEditEmpleado(editEmp.dataset);
            const editArt = e.target.closest('.btn-edit-art'); if (editArt) { const artData = Array.from(artsMap.values()).find(a => a.fbId === editArt.dataset.id); if (artData) startEditArticulo(artData); }
            const viewGrid = e.target.closest('#btn-view-grid'); if (viewGrid) { catalogoViewMode = 'grid'; document.getElementById('btn-view-grid').classList.add('active'); document.getElementById('btn-view-list').classList.remove('active'); renderCatalogo(); }
            const viewList = e.target.closest('#btn-view-list'); if (viewList) { catalogoViewMode = 'list'; document.getElementById('btn-view-list').classList.add('active'); document.getElementById('btn-view-grid').classList.remove('active'); renderCatalogo(); }
            const btnQR = e.target.closest('.btn-qr-cat'); if (btnQR) mostrarModalQR(btnQR.dataset.n);

            const addArt = e.target.closest('.btn-add-articulo');
            if (addArt) {
                 const { num, nom, hasVariants, variants } = addArt.dataset;
                 currentItemForDetails = { num, nom };
                 const vCont = document.getElementById('variant-container');
                 const vSel = document.getElementById('variant-select');
                 document.getElementById('item-qty').value = 1;
                 
                 if (hasVariants === 'true') {
                     vCont.classList.remove('hidden'); vSel.innerHTML = '<option value="">Elige...</option>';
                     const vars = JSON.parse(variants);
                     if (Array.isArray(vars)) vars.forEach(v => vSel.innerHTML += `<option value="${v.name}" data-code="${v.code}">${v.name}</option>`);
                     else if (typeof vars === 'string') vars.split(',').forEach(v => vSel.innerHTML += `<option value="${v.trim()}" data-code="${num}">${v.trim()}</option>`);
                 } else vCont.classList.add('hidden');
                 openModal('item-details-modal');
            }
            const removeArt = e.target.closest('.btn-remove-articulo'); if (removeArt) { articulosSeleccionados.splice(parseInt(removeArt.dataset.index), 1); renderCestaArticulos(); }
            const qtyPlus = e.target.closest('#btn-qty-plus'); if (qtyPlus) { document.getElementById('item-qty').value++; }
            const qtyMinus = e.target.closest('#btn-qty-minus'); if (qtyMinus) { const v = parseInt(document.getElementById('item-qty').value); if(v>1) document.getElementById('item-qty').value = v-1; }
        });

        // --- SUBMITS ---
        document.getElementById('btn-item-details-submit').onclick = () => {
             const qty = parseInt(document.getElementById('item-qty').value);
             const vSel = document.getElementById('variant-select');
             const hasVar = !document.getElementById('variant-container').classList.contains('hidden');
             if (hasVar && !vSel.value) return showToast('Elige una opci칩n', 'error');
             
             const artData = artsMap.get(currentItemForDetails.num);
             let finalCode = artData.num;
             if(hasVar) {
                 const selectedOption = vSel.options[vSel.selectedIndex];
                 finalCode = selectedOption.dataset.code || artData.num;
             }
             articulosSeleccionados.push({ ...artData, qty, variant: hasVar?vSel.value:null, variantCode: finalCode });
             renderCestaArticulos(); closeModal('item-details-modal');
        };

        document.getElementById('btn-registrar-submit').onclick = async () => {
             const reqNum = document.getElementById('reg-num-requi').value;
             const empId = document.getElementById('reg-selected-emp-id').value;
             const empName = document.getElementById('reg-selected-emp-name').value;
             if (!reqNum || !empId) return showToast('Faltan datos', 'error');
             if (!articulosSeleccionados.length) return showToast('Vac칤o', 'error');
             const btn = document.getElementById('btn-registrar-submit'); btn.disabled = true; btn.innerText = "Guardando...";
             try {
                 const ps = articulosSeleccionados.map(a => addDoc(colReqs, {
                     numRequi: reqNum, fecha: document.getElementById('reg-fecha').value, empleadoId: empId, nombre: empName,
                     articulo: `[${a.variantCode || a.num}] - ${a.nom} ${a.variant?`(${a.variant})`:''} - ${a.qty} pz`,
                     status: 'Pendiente', timestamp: new Date(), robot_partNumber: a.variantCode || a.num, robot_qty: a.qty, robot_description: a.nom, robot_price: a.precio || 0
                 }));
                 await Promise.all(ps); showToast('Guardado'); resetRegistro(); navigateTo('home-screen');
             } catch(e) { showToast('Error', 'error'); } finally { btn.disabled = false; btn.innerText = "Registrar"; }
        };
        
        // --- FORMULARIOS ---
        document.getElementById('form-add-empleado').onsubmit = async(e)=>{e.preventDefault(); await addDoc(colEmps, {id:document.getElementById('admin-emp-id').value, nombre:document.getElementById('admin-emp-nombre').value}); e.target.reset();}
        document.getElementById('form-add-categoria').onsubmit = async(e)=>{e.preventDefault(); await addDoc(colCats, {name:document.getElementById('admin-cat-name').value}); e.target.reset();}
        document.getElementById('form-add-list').onsubmit = async(e)=>{e.preventDefault(); await addDoc(colLists, {name:document.getElementById('admin-list-name').value}); e.target.reset();}
        document.getElementById('admin-art-search').addEventListener('input', renderArticulos);
        
        // --- HELPERS CRUD ---
        function startEditEmpleado(data) { editingEmpId = data.id; document.getElementById('admin-emp-id').value = data.empId; document.getElementById('admin-emp-nombre').value = data.n; document.getElementById('emp-form-title').innerText = "Editar"; document.getElementById('emp-submit-icon').innerHTML = iconEditSVG; document.getElementById('btn-cancel-emp').classList.remove('hidden'); }
        function cancelEditEmpleado() { editingEmpId = null; document.getElementById('form-add-empleado').reset(); document.getElementById('emp-form-title').innerText = "Empleados"; document.getElementById('emp-submit-icon').innerHTML = iconAddSVG; document.getElementById('btn-cancel-emp').classList.add('hidden'); }
        document.getElementById('btn-cancel-emp').onclick = cancelEditEmpleado;

        function startEditArticulo(art) {
             editingArtId = art.fbId;
             document.getElementById('admin-art-num').value = art.num; document.getElementById('admin-art-original-num').value = art.num;
             document.getElementById('admin-art-nom').value = art.nom; document.getElementById('admin-art-cat').value = art.cat;
             document.getElementById('admin-art-precio').value = art.precio; document.getElementById('admin-art-img').value = art.img;
             
             const chk = document.getElementById('admin-art-hasVariants');
             const cont = document.getElementById('variants-list-container');
             chk.checked = art.hasVariants; cont.innerHTML = '';
             if(art.hasVariants) {
                 document.getElementById('admin-variants-panel').classList.remove('hidden');
                 if(Array.isArray(art.variants)) art.variants.forEach(v => window.addVariantRow(v.name, v.code));
                 else if(typeof art.variants === 'string') art.variants.split(',').forEach(v => window.addVariantRow(v.trim(), ''));
             } else document.getElementById('admin-variants-panel').classList.add('hidden');
             
             renderArticuloListsCheckboxes(art.assignedLists);
             document.getElementById('btn-cancel-art').classList.remove('hidden');
             document.querySelector('#form-add-articulo button[type="submit"]').innerText = 'Actualizar';
             document.getElementById('form-add-articulo').scrollIntoView();
        }
        function cancelEditArticulo() {
             editingArtId = null; document.getElementById('form-add-articulo').reset();
             document.getElementById('btn-cancel-art').classList.add('hidden');
             document.getElementById('admin-variants-panel').classList.add('hidden');
             document.getElementById('variants-list-container').innerHTML='';
             document.querySelector('#form-add-articulo button[type="submit"]').innerText = 'Guardar';
             renderArticuloListsCheckboxes();
        }
        document.getElementById('btn-cancel-art').onclick = cancelEditArticulo;

        // --- AUTOCOMPLETE EMP ---
        const empIn = document.getElementById('reg-emp-search'); const empRes = document.getElementById('reg-emp-results');
        empIn.addEventListener('input', e => {
            const v = e.target.value.toLowerCase();
            if(!v) { empRes.classList.add('hidden'); return; }
            const m = Array.from(empsMap.values()).filter(x => x.nombre.toLowerCase().includes(v) || x.id.toString().includes(v));
            empRes.innerHTML = m.map(x => `<div class="p-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="window.selEmp('${x.id}','${x.nombre}')"><b>${x.nombre}</b> (${x.id})</div>`).join('');
            empRes.classList.remove('hidden');
        });
        window.selEmp = (id, n) => { document.getElementById('reg-selected-emp-id').value=id; document.getElementById('reg-selected-emp-name').value=n; empIn.value=`${n} (${id})`; empRes.classList.add('hidden'); };
        document.getElementById('btn-clear-emp').onclick = () => { empIn.value=''; document.getElementById('reg-selected-emp-id').value=''; document.getElementById('reg-selected-emp-name').value=''; };

        // --- EXCEL & LOGIN ---
        document.getElementById('file-upload-emp').onchange = async (e) => {
             const f = e.target.files[0]; if(!f) return; const r = new FileReader();
             r.onload = async (evt) => { const wb = XLSX.read(evt.target.result,{type:'binary'}); const d = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}); d.forEach(async r=>{if(r[0]&&r[1]&&!empsMap.has(r[0].toString())) await addDoc(colEmps,{id:r[0].toString(),nombre:r[1].toString()})}); showToast('Cargando...'); };
             r.readAsBinaryString(f);
        };
        document.getElementById('form-login').onsubmit = async(e)=>{e.preventDefault(); try{await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); closeModal('login-modal');}catch{showToast('Error','error');}};
        document.getElementById('btn-login-icon').onclick=()=>openModal('login-modal');
        document.getElementById('btn-logout').onclick=()=>signOut(auth);
        document.getElementById('btn-confirm-ok').onclick=()=>{if(confirmAction)confirmAction(); closeModal('confirm-modal');};

        // --- ARRANQUE ---
        function checkQR() { const p = new URLSearchParams(window.location.search); const c = p.get('cat'); if(c) { currentCategory=c; navigateTo('catalogo-screen'); renderCatalogoFilters(); registrarTrafico(c); } else registrarTrafico(null); }
        function setInitialIcons() { const empIcon = document.getElementById('emp-submit-icon'); if (empIcon) empIcon.innerHTML = iconAddSVG; }
        window.mostrarQR = (n) => { document.getElementById('qr-category-name').innerText=n; document.getElementById('qrcode-container').innerHTML=''; new QRCode(document.getElementById('qrcode-container'),{text:window.location.href.split('?')[0]+'?cat='+encodeURIComponent(n),width:150,height:150}); openModal('qr-modal'); }
        window.imprimirQR = () => { const w=window.open('','','height=400,width=400'); w.document.write('<html><body style="text-align:center"><h2>'+document.getElementById('qr-category-name').innerText+'</h2>'+document.getElementById('qrcode-container').innerHTML+'</body></html>'); w.document.close(); w.focus(); setTimeout(()=>w.print(),500); }

        setInitialIcons(); checkQR();
    </script>
</body>
</html>