<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToolCrib Requisitions</title>
    <!-- 1. Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Configuración de Tailwind y Fuentes -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            '50': '#eff6ff',
                            '100': '#dbeafe',
                            '200': '#bfdbfe',
                            '300': '#93c5fd',
                            '400': '#60a5fa',
                            '500': '#3b82f6',
                            '600': '#2563eb',
                            '700': '#1d4ed8',
                            '800': '#1e40af',
                            '900': '#1e3a8a',
                            '950': '#172554',
                        },
                    }
                }
            }
        }
    </script>
    <!-- 3. Estilos CSS personalizados -->
    <style>
        /* Estilo para ocultar elementos al inicio hasta que Vue/JS los maneje */
        [v-cloak] {
            display: none;
        }
        /* Transición suave para modales */
        .modal {
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Estilo para los inputs */
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500;
        }
        /* Estilo para los botones principales */
        .btn {
            @apply px-4 py-2 rounded-md font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        /* Estilo para las pestañas de navegación */
        .nav-tab {
            @apply px-4 py-2 font-medium text-gray-500 rounded-t-lg hover:text-gray-700 hover:bg-gray-100;
        }
        .nav-tab.active {
            @apply bg-white text-primary-600 border-b-2 border-primary-600;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Contenedor Principal -->
    <div id="app-container" class="min-h-screen flex flex-col">

        <!-- Barra de Navegación / Encabezado -->
        <header class="bg-primary-800 text-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo / Título -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-8 text-primary-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v.001h.001v-.001H3.75Zm0 3.75v.001h.001v-.001H3.75Zm0 3.75v.001h.001v-.001H3.75Zm0 3.75v.001h.001v-.001H3.75Zm0 3.75v.001h.001v-.001H3.75Zm3.75 0v.001h.001v-.001H7.5Zm3.75 0v.001h.001v-.001H11.25Zm3.75 0v.001h.001v-.001H15Zm3.75 0v.001h.001v-.001H18.75Zm-3.75-3.75v.001h.001v-.001H15Zm0-3.75v.001h.001v-.001H15Zm0-3.75v.001h.001v-.001H15Zm0-3.75V3.75v.001h.001v-.001H15Zm-3.75 3.75v.001h.001v-.001H11.25Zm0-3.75V3.75v.001h.001v-.001H11.25Zm-3.75 0V3.75v.001h.001v-.001H7.5Zm0 3.75v.001h.001v-.001H7.5Z" />
                        </svg>
                        <span class="ml-3 text-2xl font-bold">ToolCrib Admin</span>
                    </div>
                    <!-- Info de Usuario y Login -->
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-primary-200">
                            User ID: <span id="user-id-display" class="font-medium">Cargando...</span>
                        </div>
                        <button id="btn-login-icon" class="text-primary-200 hover:text-white transition-colors">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-.907L12 3.28c.55.1 1.02.565 1.11.907l.095.45c.306.115.61.25.908.4l.43.195c.523.238.982.697 1.119 1.241l.12.51c.264.18.517.388.756.621l.45.419c.47.438.724 1.065.596 1.673l-.12.582c.03.176.05.357.05.541s-.02.365-.05.541l.12.582c.128.608-.126 1.235-.596 1.673l-.45.419c-.24.233-.492.441-.756.621l-.12.51c-.137.544-.596 1.003-1.119 1.241l-.43.195c-.298.15-.602.284-.908.4l-.095.45c-.09.542-.56 1.007-1.11.907L12 20.72c-.55-.1-1.02-.565-1.11-.907l-.095-.45c-.306-.115-.61-.25-.908-.4l-.43-.195c-.523-.238-.982-.697-1.119-1.241l-.12-.51c-.264-.18-.517-.388-.756-.621l-.45-.419c-.47-.438-.724-1.065-.596-1.673l.12-.582c-.03-.176-.05-.357-.05-.541s.02-.365.05-.541l-.12-.582c-.128-.608.126-1.235.596-1.673l.45-.419c.24-.233.492-.441.756-.621l.12-.51c.137-.544.596-1.003 1.119 1.241l.43-.195c.298-.15.602-.284.908-.4l.095-.45Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                        </button>
                        <button id="btn-logout" class="btn btn-secondary hidden text-sm py-1 px-3">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="flex-grow max-w-7xl w-full mx-auto p-4 sm:p-6 lg:p-8">

            <!-- Navegación de Pestañas -->
            <div class="mb-6">
                <nav class="flex space-x-2" aria-label="Tabs">
                    <button data-screen="home-screen" class="nav-tab active">Inicio</button>
                    <button data-screen="consultar-screen" class="nav-tab">Consultar Requisiciones</button>
                    <button id="btn-admin-nav" data-screen="admin-screen" class="nav-tab hidden">Administración</button>
                </nav>
            </div>

            <!-- Pantalla: Inicio -->
            <div id="home-screen" class="screen-content bg-white p-6 sm:p-8 rounded-lg shadow">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Bienvenido al Sistema de Requisiciones</h1>
                <p class="text-lg text-gray-600 mb-6">Seleccione una opción para comenzar.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="btn-registrar-nav" class="w-full text-left p-6 bg-primary-600 text-white rounded-lg shadow-md hover:bg-primary-700 transition-all transform hover:scale-105">
                        <h2 class="text-2xl font-semibold mb-2">Registrar Requisición</h2>
                        <p>Crear una nueva solicitud de artículo.</p>
                    </button>
                    <button data-screen-nav="consultar-screen" class="w-full text-left p-6 bg-white text-gray-900 rounded-lg shadow-md hover:bg-gray-50 transition-all transform hover:scale-105 border border-gray-200">
                        <h2 class="text-2xl font-semibold mb-2">Consultar Requisiciones</h2>
                        <p>Ver el historial y estado de las solicitudes.</p>
                    </button>
                </div>
            </div>

            <!-- Pantalla: Consultar Requisiciones -->
            <div id="consultar-screen" class="screen-content hidden bg-white p-6 sm:p-8 rounded-lg shadow">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Requisiciones Generadas</h1>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Empleado</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Artículo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estatus</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-requisiciones" class="bg-white divide-y divide-gray-200">
                            <!-- Filas se insertarán dinámicamente aquí -->
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Cargando requisiciones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pantalla: Administración (Oculta por defecto) -->
            <div id="admin-screen" class="screen-content hidden">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Panel de Administración</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Columna 1: Empleados -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gestionar Empleados</h2>
                        <!-- Formulario para agregar empleado -->
                        <form id="form-add-empleado" class="mb-6 space-y-4">
                            <div>
                                <label for="admin-emp-id" class="block text-sm font-medium text-gray-700">Número de Empleado</label>
                                <input type="number" id="admin-emp-id" name="admin-emp-id" required>
                            </div>
                            <div>
                                <label for="admin-emp-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                <input type="text" id="admin-emp-nombre" name="admin-emp-nombre" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Agregar Empleado</button>
                        </form>
                        <!-- Lista de empleados -->
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Empleados Registrados</h3>
                        <div id="admin-list-empleados" class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>

                    <!-- Columna 2: Artículos -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gestionar Artículos</h2>
                        <!-- Formulario para agregar artículo -->
                        <form id="form-add-articulo" class="mb-6 space-y-4">
                            <div>
                                <label for="admin-art-nombre" class="block text-sm font-medium text-gray-700">Nombre del Artículo</label>
                                <input type="text" id="admin-art-nombre" name="admin-art-nombre" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Agregar Artículo</button>
                        </form>
                        <!-- Lista de artículos -->
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Artículos Registrados</h3>
                        <div id="admin-list-articulos" class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALES -->

    <!-- Modal: Registrar Requisición -->
    <div id="registrar-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg relative transform scale-95 opacity-0">
            <!-- Botón de cerrar -->
            <button data-dismiss="modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">Registrar Nueva Requisición</h2>
            
            <form id="form-registrar" class="space-y-4">
                <div>
                    <label for="reg-empleado-id" class="block text-sm font-medium text-gray-700">Número de Empleado</label>
                    <input type="number" id="reg-empleado-id" name="reg-empleado-id" required>
                </div>
                <div>
                    <label for="reg-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="reg-nombre" name="reg-nombre" readonly class="bg-gray-100" placeholder="Se rellenará automáticamente">
                </div>
                <div>
                    <label for="reg-articulo" class="block text-sm font-medium text-gray-700">Artículo</label>
                    <select id="reg-articulo" name="reg-articulo" required>
                        <option value="">Seleccione un artículo...</option>
                        <!-- Opciones se cargarán dinámicamente -->
                    </select>
                </div>
                <div>
                    <label for="reg-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="text" id="reg-fecha" name="reg-fecha" readonly class="bg-gray-100">
                </div>
                
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" data-dismiss="modal" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Iniciar Sesión -->
    <div id="login-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-sm relative transform scale-95 opacity-0">
            <!-- Botón de cerrar -->
            <button data-dismiss="modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-semibold text-gray-900 mb-6 text-center">Inicio de Sesión</h2>
            
            <form id="form-login" class="space-y-4">
                <div>
                    <label for="login-user" class="block text-sm font-medium text-gray-700">Usuario</label>
                    <input type="text" id="login-user" name="login-user" value="admin" class="bg-gray-100">
                </div>
                <div>
                    <label for="login-pass" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="login-pass" name="login-pass" placeholder="Pista: admin">
                </div>
                
                <div class="pt-4 flex flex-col space-y-3">
                    <button type="submit" class="btn btn-primary w-full">Entrar</button>
                    <button type="button" data-dismiss="modal" class="btn btn-secondary w-full">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cambiar Estatus -->
    <div id="status-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-sm relative transform scale-95 opacity-0">
            <!-- Botón de cerrar -->
            <button data-dismiss="modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">Cambiar Estatus</h2>
            <p class="text-gray-600 mb-6">Seleccione el nuevo estatus para la requisición <span id="status-req-id" class="font-medium"></span>.</p>
            
            <div class="space-y-3">
                <button id="btn-status-auth" class="btn btn-primary w-full">Autorizada</button>
                <button id="btn-status-cobrada" class="btn btn-primary w-full">Cobrada</button>
                <button id="btn-status-pendiente" class="btn btn-secondary w-full">Pendiente</button>
                <button data-dismiss="modal" class="btn btn-secondary w-full mt-4">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Alerta/Confirmación Genérico -->
    <div id="alert-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-sm relative transform scale-95 opacity-0">
            <div class="flex items-start">
                <div id="alert-icon-container" class="flex-shrink-0">
                    <!-- Icono se insertará dinámicamente -->
                </div>
                <div class="ml-4">
                    <h3 id="alert-title" class="text-lg font-medium text-gray-900"></h3>
                    <p id="alert-message" class="text-sm text-gray-600 mt-2"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="alert-close-btn" class="btn btn-primary">Entendido</button>
            </div>
        </div>
    </div>


    <!-- 4. Scripts de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES Y CONFIGURACIÓN ---
        
        // Configuración de Firebase (se inyectará en el entorno)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toolcrib-app-dev';
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Habilitar logs de Firestore para depuración
        setLogLevel('Debug');

        // Estado de la aplicación
        let currentUserId = null; // UID del usuario de Firebase
        let isLoggedIn = false; // Estado de login de "admin"
        let currentEditingRequisitionId = null; // ID de la requisición que se está editando

        // Caché de datos locales (Map para búsqueda rápida)
        let empleadosMap = new Map();
        let articulosMap = new Map();

        // Referencias a colecciones de Firestore
        let requisitionsCollection = null;
        let employeesCollection = null;
        let articlesCollection = null;

        // Descriptores de onSnapshot para limpieza
        let unsubscribeRequisitions = () => {};
        let unsubscribeEmployees = () => {};
        let unsubscribeArticles = () => {};

        // --- SELECTORES DEL DOM ---
        
        // Botones de navegación principal
        const navTabs = document.querySelectorAll('.nav-tab');
        const screenNavButtons = document.querySelectorAll('[data-screen-nav]');
        const screens = document.querySelectorAll('.screen-content');
        const btnAdminNav = document.getElementById('btn-admin-nav');
        
        // Botones de login/logout
        const btnLoginIcon = document.getElementById('btn-login-icon');
        const btnLogout = document.getElementById('btn-logout');
        const userIdDisplay = document.getElementById('user-id-display');

        // Modal de Registro
        const btnRegistrarNav = document.getElementById('btn-registrar-nav');
        const registrarModal = document.getElementById('registrar-modal');
        const formRegistrar = document.getElementById('form-registrar');
        const regEmpleadoIdInput = document.getElementById('reg-empleado-id');
        const regNombreInput = document.getElementById('reg-nombre');
        const regArticuloSelect = document.getElementById('reg-articulo');
        const regFechaInput = document.getElementById('reg-fecha');

        // Modal de Login
        const loginModal = document.getElementById('login-modal');
        const formLogin = document.getElementById('form-login');
        const loginPassInput = document.getElementById('login-pass');

        // Modal de Estatus
        const statusModal = document.getElementById('status-modal');
        const statusReqIdSpan = document.getElementById('status-req-id');
        const btnStatusAuth = document.getElementById('btn-status-auth');
        const btnStatusCobrada = document.getElementById('btn-status-cobrada');
        const btnStatusPendiente = document.getElementById('btn-status-pendiente');

        // Modal de Alerta
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertIconContainer = document.getElementById('alert-icon-container');
        const alertCloseBtn = document.getElementById('alert-close-btn');

        // Pantalla de Consulta
        const tbodyRequisiciones = document.getElementById('tbody-requisiciones');

        // Pantalla de Admin
        const formAddEmpleado = document.getElementById('form-add-empleado');
        const adminEmpIdInput = document.getElementById('admin-emp-id');
        const adminEmpNombreInput = document.getElementById('admin-emp-nombre');
        const adminListEmpleados = document.getElementById('admin-list-empleados');
        
        const formAddArticulo = document.getElementById('form-add-articulo');
        const adminArtNombreInput = document.getElementById('admin-art-nombre');
        const adminListArticulos = document.getElementById('admin-list-articulos');

        // --- FUNCIONES DE UTILIDAD (MODALES Y ALERTAS) ---

        /**
         * Muestra un modal por su ID
         * @param {string} modalId - El ID del modal a mostrar
         */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.remove('hidden');
            // Forzar reflujo para activar la transición
            void modal.offsetWidth; 
            
            const modalContent = modal.querySelector('.modal-content');
            modal.classList.add('opacity-100', 'scale-100');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }

        /**
         * Cierra un modal por su ID
         * @param {string} modalId - El ID del modal a cerrar
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            const modalContent = modal.querySelector('.modal-content');
            modal.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250); // Coincidir con la duración de la transición
        }

        /**
         * Muestra una alerta modal personalizada.
         * @param {string} title - Título de la alerta.
         * @param {string} message - Mensaje de la alerta.
         * @param {boolean} [isError=false] - Si es una alerta de error (icono rojo) o de éxito (icono verde).
         */
        function showAlert(title, message, isError = false) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;

            if (isError) {
                alertIconContainer.innerHTML = `
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>`;
                alertCloseBtn.className = 'btn btn-danger';
            } else {
                alertIconContainer.innerHTML = `
                    <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>`;
                alertCloseBtn.className = 'btn btn-primary';
            }
            openModal('alert-modal');
        }

        // --- LÓGICA DE NAVEGACIÓN ---

        /**
         * Muestra una pantalla y oculta las demás.
         * @param {string} screenId - ID de la pantalla a mostrar (ej. 'home-screen').
         */
        function showScreen(screenId) {
            // Ocultar todas las pantallas
            screens.forEach(screen => {
                screen.classList.add('hidden');
            });
            // Quitar clase 'active' de todas las pestañas
            navTabs.forEach(tab => {
                tab.classList.remove('active', 'bg-white', 'text-primary-600', 'border-b-2', 'border-primary-600');
                tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
            });

            // Mostrar la pantalla seleccionada
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) {
                activeScreen.classList.remove('hidden');
            }
            
            // Activar la pestaña correspondiente
            const activeTab = document.querySelector(`.nav-tab[data-screen="${screenId}"]`);
            if (activeTab) {
                activeTab.classList.add('active', 'bg-white', 'text-primary-600', 'border-b-2', 'border-primary-600');
                activeTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
            }
        }

        // --- LÓGICA DE AUTENTICACIÓN (Firebase y Admin) ---

        /**
         * Maneja el cambio de estado de autenticación de Firebase.
         */
        async function handleAuthState(user) {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                console.log("Usuario autenticado (Firebase):", currentUserId);

                // Definir rutas de colecciones (dependen del userId)
                // Usamos rutas "privadas" para empleados y artículos (solo admin)
                employeesCollection = collection(db, 'artifacts', appId, 'users', currentUserId, 'employees');
                articlesCollection = collection(db, 'artifacts', appId, 'users', currentUserId, 'articles');
                
                // Usamos una ruta "pública" para las requisiciones (todos pueden ver)
                requisitionsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'requisitions');
                
                // Iniciar listeners de datos
                startDataListeners();
            } else {
                console.log("Usuario no autenticado.");
                currentUserId = null;
                userIdDisplay.textContent = 'N/A';
                // Detener listeners si el usuario se desconecta
                stopDataListeners();
            }
        }

        /**
         * Inicia sesión anónima o con token personalizado.
         */
        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Iniciando sesión con Custom Token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Iniciando sesión anónimamente...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error en la autenticación inicial:", error);
                showAlert("Error de Autenticación", "No se pudo conectar con el servidor. Por favor, recargue la página.", true);
            }
        }
        
        /**
         * Maneja el "inicio de sesión" del administrador (simulado).
         */
        function handleAdminLogin(e) {
            e.preventDefault();
            const pass = loginPassInput.value;
            // Contraseña simulada. En un caso real, esto usaría Firebase Auth (Email/Pass, etc.)
            if (pass === 'admin') {
                isLoggedIn = true;
                btnAdminNav.classList.remove('hidden');
                btnLoginIcon.classList.add('hidden');
                btnLogout.classList.remove('hidden');
                closeModal('login-modal');
                showAlert('Inicio de Sesión', 'Sesión de administrador iniciada correctamente.');
                loginPassInput.value = '';
                // Volver a renderizar las requisiciones para mostrar botones de admin
                renderRequisitions(); 
            } else {
                showAlert('Error', 'Contraseña incorrecta. (Pista: admin)', true);
            }
        }

        /**
         * Maneja el "cierre de sesión" del administrador.
         */
        function handleAdminLogout() {
            isLoggedIn = false;
            btnAdminNav.classList.add('hidden');
            btnLoginIcon.classList.remove('hidden');
            btnLogout.classList.add('hidden');
            showAlert('Sesión Cerrada', 'Ha cerrado la sesión de administrador.');
            // Si estaba en la pantalla de admin, volver al inicio
            if (!document.getElementById('admin-screen').classList.contains('hidden')) {
                showScreen('home-screen');
            }
            // Volver a renderizar las requisiciones para ocultar botones de admin
            renderRequisitions();
        }

        // --- LÓGICA DE DATOS (FIRESTORE) ---

        /**
         * Inicia todos los listeners de onSnapshot.
         */
        function startDataListeners() {
            if (!requisitionsCollection || !employeesCollection || !articlesCollection) {
                console.error("Las colecciones no están listas. No se inician listeners.");
                return;
            }

            console.log("Iniciando listeners...");

            // 1. Listener para Requisiciones (Público)
            unsubscribeRequisitions = onSnapshot(requisitionsCollection, (snapshot) => {
                const reqs = [];
                snapshot.forEach((doc) => {
                    reqs.push({ id: doc.id, ...doc.data() });
                });
                // Ordenar por fecha (más nuevas primero)
                reqs.sort((a, b) => b.fecha.localeCompare(a.fecha));
                renderRequisitions(reqs);
            }, (error) => console.error("Error al escuchar requisiciones:", error));

            // 2. Listener para Empleados (Privado/Admin)
            unsubscribeEmployees = onSnapshot(employeesCollection, (snapshot) => {
                empleadosMap.clear();
                const empleadosList = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Usamos el 'id' (No. Empleado) como clave del Map
                    empleadosMap.set(data.id, data.nombre);
                    empleadosList.push({ ...data, fbId: doc.id }); // fbId es el ID del documento
                });
                renderAdminListEmpleados(empleadosList);
                console.log("Empleados cargados:", empleadosMap.size);
            }, (error) => console.error("Error al escuchar empleados:", error));

            // 3. Listener para Artículos (Privado/Admin)
            unsubscribeArticles = onSnapshot(articlesCollection, (snapshot) => {
                articulosMap.clear();
                const articulosList = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Usamos el nombre como clave y valor (o podríamos usar el fbId)
                    articulosMap.set(data.nombre, data.nombre);
                    articulosList.push({ ...data, fbId: doc.id });
                });
                renderArticulosDropdown();
                renderAdminListArticulos(articulosList);
                console.log("Artículos cargados:", articulosMap.size);
            }, (error) => console.error("Error al escuchar artículos:", error));
        }

        /**
         * Detiene todos los listeners de onSnapshot.
         */
        function stopDataListeners() {
            console.log("Deteniendo listeners...");
            unsubscribeRequisitions();
            unsubscribeEmployees();
            unsubscribeArticles();
        }

        // --- LÓGICA DE RENDERIZADO (UI) ---

        /**
         * Renderiza la tabla de requisiciones.
         * @param {Array} [reqs] - Array de requisiciones. Si no se provee, muestra "Cargando...".
         */
        function renderRequisitions(reqs = null) {
            if (!reqs) {
                tbodyRequisiciones.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Cargando requisiciones...</td></tr>`;
                return;
            }
            if (reqs.length === 0) {
                tbodyRequisiciones.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay requisiciones registradas.</td></tr>`;
                return;
            }

            tbodyRequisiciones.innerHTML = reqs.map(req => {
                const statusBadge = renderStatusBadge(req.status);
                const disabled = !isLoggedIn ? 'disabled' : '';
                const cursor = !isLoggedIn ? 'cursor-not-allowed opacity-50' : 'cursor-pointer hover:scale-105';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${req.fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${req.empleadoId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${req.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${req.articulo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button 
                                data-id="${req.id}" 
                                data-status="${req.status}" 
                                class="status-btn inline-block transition-transform ${cursor}" 
                                ${disabled}
                                title="${isLoggedIn ? 'Clic para cambiar estatus' : 'Inicie sesión para editar'}"
                            >
                                ${statusBadge}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Devuelve el HTML para un badge de estatus.
         * @param {string} status - El estatus ('Pendiente', 'Autorizada', 'Cobrada').
         */
        function renderStatusBadge(status) {
            let colorClasses = 'bg-yellow-100 text-yellow-800'; // Pendiente (default)
            if (status === 'Autorizada') {
                colorClasses = 'bg-green-100 text-green-800';
            } else if (status === 'Cobrada') {
                colorClasses = 'bg-blue-100 text-blue-800';
            }
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClasses}">${status}</span>`;
        }

        /**
         * Renderiza el dropdown de artículos en el modal de registro.
         */
        function renderArticulosDropdown() {
            regArticuloSelect.innerHTML = '<option value="">Seleccione un artículo...</option>';
            if (articulosMap.size === 0) {
                regArticuloSelect.innerHTML += '<option value="" disabled>No hay artículos registrados</option>';
            }
            // Ordenar alfabéticamente
            const sortedArticulos = Array.from(articulosMap.keys()).sort();
            sortedArticulos.forEach(nombre => {
                regArticuloSelect.innerHTML += `<option value="${nombre}">${nombre}</option>`;
            });
        }

        /**
         * Renderiza la lista de empleados en el panel de admin.
         * @param {Array} empleados - Lista de empleados.
         */
        function renderAdminListEmpleados(empleados) {
            if (empleados.length === 0) {
                adminListEmpleados.innerHTML = '<p class="text-gray-500">No hay empleados registrados.</p>';
                return;
            }
            adminListEmpleados.innerHTML = empleados.map(emp => `
                <div class="flex justify-between items-center p-2 hover:bg-gray-100 rounded">
                    <span class="text-sm"><strong>${emp.id}</strong> - ${emp.nombre}</span>
                    <!-- Aquí se podría agregar un botón de borrar -->
                </div>
            `).join('');
        }

        /**
         * Renderiza la lista de artículos en el panel de admin.
         * @param {Array} articulos - Lista de artículos.
         */
        function renderAdminListArticulos(articulos) {
            if (articulos.length === 0) {
                adminListArticulos.innerHTML = '<p class="text-gray-500">No hay artículos registrados.</p>';
                return;
            }
            adminListArticulos.innerHTML = articulos.map(art => `
                <div class="flex justify-between items-center p-2 hover:bg-gray-100 rounded">
                    <span class="text-sm">${art.nombre}</span>
                    <!-- Aquí se podría agregar un botón de borrar -->
                </div>
            `).join('');
        }
        
        // --- MANEJADORES DE EVENTOS ---

        /**
         * Manejador para el formulario de Registro de Requisición.
         */
        async function handleRegistrarSubmit(e) {
            e.preventDefault();
            const data = {
                empleadoId: regEmpleadoIdInput.value,
                nombre: regNombreInput.value,
                articulo: regArticuloSelect.value,
                fecha: regFechaInput.value,
                status: 'Pendiente' // Estatus inicial
            };

            // Validación simple
            if (!data.empleadoId || !data.nombre || !data.articulo) {
                showAlert('Datos Incompletos', 'Asegúrese de que el No. de Empleado sea válido y haya seleccionado un artículo.', true);
                return;
            }

            try {
                await addDoc(requisitionsCollection, data);
                showAlert('Éxito', 'Requisición registrada correctamente.');
                closeModal('registrar-modal');
                formRegistrar.reset();
            } catch (error) {
                console.error("Error al registrar requisición:", error);
                showAlert('Error', 'No se pudo registrar la requisición. Intente de nuevo.', true);
            }
        }

        /**
         * Manejador para el formulario de Agregar Empleado (Admin).
         */
        async function handleAddEmpleado(e) {
            e.preventDefault();
            const empId = adminEmpIdInput.value;
            const nombre = adminEmpNombreInput.value;

            if (!empId || !nombre) {
                showAlert('Error', 'Debe ingresar un ID y un Nombre.', true);
                return;
            }
            
            // Verificar si el empleado ya existe (basado en el ID)
            if (empleadosMap.has(empId)) {
                showAlert('Error', `El número de empleado ${empId} ya está registrado.`, true);
                return;
            }

            try {
                await addDoc(employeesCollection, { id: empId, nombre: nombre });
                showAlert('Éxito', 'Empleado agregado correctamente.');
                formAddEmpleado.reset();
            } catch (error) {
                console.error("Error al agregar empleado:", error);
                showAlert('Error', 'No se pudo agregar el empleado.', true);
            }
        }

        /**
         * Manejador para el formulario de Agregar Artículo (Admin).
         */
        async function handleAddArticulo(e) {
            e.preventDefault();
            const nombre = adminArtNombreInput.value.trim();
            if (!nombre) {
                showAlert('Error', 'Debe ingresar un nombre para el artículo.', true);
                return;
            }

            // Verificar si el artículo ya existe
            if (articulosMap.has(nombre)) {
                showAlert('Error', `El artículo "${nombre}" ya está registrado.`, true);
                return;
            }

            try {
                await addDoc(articlesCollection, { nombre: nombre });
                showAlert('Éxito', 'Artículo agregado correctamente.');
                formAddArticulo.reset();
            } catch (error) {
                console.error("Error al agregar artículo:", error);
                showAlert('Error', 'No se pudo agregar el artículo.', true);
            }
        }

        /**
         * Manejador para el autocompletado de nombre de empleado.
         */
        function handleEmpleadoIdInput() {
            const empId = regEmpleadoIdInput.value;
            const nombre = empleadosMap.get(empId);
            if (nombre) {
                regNombreInput.value = nombre;
            } else {
                regNombreInput.value = '';
            }
        }

        /**
         * Abre el modal de cambio de estatus.
         */
        function handleOpenStatusModal(e) {
            const btn = e.target.closest('.status-btn');
            if (!btn || !isLoggedIn) return; // Doble chequeo por si acaso

            currentEditingRequisitionId = btn.dataset.id;
            statusReqIdSpan.textContent = `(ID: ...${currentEditingRequisitionId.slice(-6)})`;
            openModal('status-modal');
        }

        /**
         * Cambia el estatus de la requisición seleccionada.
         * @param {string} newStatus - El nuevo estatus.
         */
        async function handleChangeStatus(newStatus) {
            if (!currentEditingRequisitionId) return;

            try {
                const docRef = doc(requisitionsCollection, currentEditingRequisitionId);
                await updateDoc(docRef, { status: newStatus });
                showAlert('Éxito', 'Estatus actualizado correctamente.');
                closeModal('status-modal');
                currentEditingRequisitionId = null;
            } catch (error) {
                console.error("Error al cambiar estatus:", error);
                showAlert('Error', 'No se pudo actualizar el estatus.', true);
            }
        }
        
        /**
         * Obtiene la fecha de hoy en formato YYYY-MM-DD
         */
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // --- INICIALIZACIÓN DE EVENTOS ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar autenticación de Firebase
            onAuthStateChanged(auth, handleAuthState);
            initializeAuth();

            // Navegación de pestañas
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const screenId = tab.dataset.screen;
                    showScreen(screenId);
                });
            });

            // Botones de navegación (como el de "Consultar" en la home)
            screenNavButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const screenId = btn.dataset.screenNav;
                    showScreen(screenId);
                });
            });

            // Botones de Login/Logout
            btnLoginIcon.addEventListener('click', () => openModal('login-modal'));
            btnLogout.addEventListener('click', handleAdminLogout);
            formLogin.addEventListener('submit', handleAdminLogin);

            // Botones para abrir modales
            btnRegistrarNav.addEventListener('click', () => {
                regFechaInput.value = getTodayDate(); // Poner fecha actual
                openModal('registrar-modal');
            });

            // Botones para cerrar modales (global)
            document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                const modalId = btn.closest('.modal').id;
                btn.addEventListener('click', () => closeModal(modalId));
            });
            alertCloseBtn.addEventListener('click', () => closeModal('alert-modal'));

            // Formularios
            formRegistrar.addEventListener('submit', handleRegistrarSubmit);
            formAddEmpleado.addEventListener('submit', handleAddEmpleado);
            formAddArticulo.addEventListener('submit', handleAddArticulo);

            // Autocompletado de empleado
            regEmpleadoIdInput.addEventListener('input', handleEmpleadoIdInput);

            // Tabla de requisiciones (delegación de eventos)
            tbodyRequisiciones.addEventListener('click', handleOpenStatusModal);

            // Botones de cambio de estatus
            btnStatusAuth.addEventListener('click', () => handleChangeStatus('Autorizada'));
            btnStatusCobrada.addEventListener('click', () => handleChangeStatus('Cobrada'));
            btnStatusPendiente.addEventListener('click', () => handleChangeStatus('Pendiente'));

            // Iniciar en la pantalla de inicio
            showScreen('home-screen');
        });
        
    </script>

</body>
</html>
